<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDG Analysis Dashboard</title>
  <link rel="icon" href="assets/images/logo/favicon.png" type="image/png">

  <!-- D3 and Plotly -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="src/js/barchart.js?v=4.3"></script>
  <script src="src/js/lollipop.js?v=4.3"></script>
  <script src="src/js/heatmap.js?v=4.3"></script>
  <script src="src/js/bubblechart.js?v=4.3"></script>
  <script src="src/js/donutchart.js?v=4.3"></script>
  <script src="src/js/treemap.js?v=4.3"></script>

  <link rel="stylesheet" href="src/css/style.css?v=4.3">
</head>

<body>
  <!-- Toggle Button for Sidebar on small screens REMOVED -->

  <!-- INTRO MODAL (Explainer) -->
  <div class="modal-overlay" id="welcomeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Welcome to the SDG Analysis Dashboard</h2>
        <button class="close-modal" onclick="hideWelcomeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-intro-text">
          <p>This interactive dashboard helps you explore how university courses map to the UN Sustainable Development Goals (SDGs). You can start by exploring the different tabs, searching for a specialisation, or selecting an SDG.</p>
          <p class="modal-warning">
            <strong>Note:</strong> There are four analysis, v1 and v2 overpredicts (high recall at the expense of precision), v3 underpredicts (high precision at the expense of recall), v4 attemps to strike a better balance but reliance on public usually leads to underestimating SDG coverage (sometimes severly). Use the version toggle for different perspectives.
          </p>
        </div>

        <div class="modal-main-actions">
          <div class="modal-action-card">
            <h3><span class="card-icon">üèõÔ∏è</span>Explore by View</h3>
            <p>Use the main tabs to see different perspectives of the data.</p>
            <div class="modal-tabs-info">
              <button class="modal-link" onclick="switchToTab('#tab3Content')"><strong>University Goals</strong><br>High-level overview across the university.</button>
              <button class="modal-link" onclick="switchToTab('#tab4Content')"><strong>University Targets</strong><br>Coverage by specific SDG targets.</button>
              <button class="modal-link" onclick="switchToTab('#tab1Content')"><strong>Specialisation Goals</strong><br>Deep dive into a specific specialisation.</button>
              <button class="modal-link" onclick="switchToTab('#tab5Content')"><strong>Specialisation Targets</strong><br>Target breakdown for a specialisation.</button>
              <button class="modal-link" onclick="switchToTab('#tab2Content')"><strong>SDG Breakdown</strong><br>Coverage for a selected SDG.</button>
            </div>
          </div>
          <div class="modal-action-card">
            <h3><span class="card-icon">üîç</span>Find a Specialisation</h3>
            <p>Jump directly to the analysis for a specific area of study.</p>
            <div class="search-container" id="modal-search-container">
              <input type="text" id="modalDisciplineSearch" placeholder="Search specialisations..." class="search-input">
              <div id="modalDisciplineDropdown" class="dropdown-content"></div>
            </div>
          </div>
          <div class="modal-action-card">
            <h3><span class="card-icon">üéØ</span>Select an SDG</h3>
            <p>See how a specific SDG is covered across all specialisations.</p>
            <div class="modal-sdg-icons">
              <div class="sdg-icons-list" id="modalSdgIconsList">
                <!-- SDG Icons will be populated here by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-disclaimer">
          <details>
            <summary>Disclaimer & Limitations</summary>
            <div class="modal-disclaimer-content">
              <p>
                This visualization represents a high-level, automated mapping of UN Sustainable Development Goals
                (SDGs) across courses. Please note:
              </p>
              <ul>
                <li>This dashboard is provided "as is" and "as available" without any warranties of any kind, express or implied, including but not limited to warranties of merchantability, fitness for a particular purpose, or non-infringement. We make no guarantee regarding the accuracy, completeness, or reliability of the data or visualizations presented herein.</li>
                <li>This is an automated, preliminary analysis based solely on publicly available course information</li>
                <li>The mapping is likely incomplete and may contain inaccuracies</li>
                <li>Many course activities, assessments, and learning outcomes that address SDGs may not be captured</li>
                <li>This tool is not intended to replace detailed curriculum mapping efforts</li>
                <li>This visualization serves as a broad overview to complement more comprehensive manual assessment processes</li>
                <li>For accurate, detailed SDG mapping, please refer to official course documentation and detailed curriculum mapping initiatives</li>
                <li>We intend this mapping to be a genuine tool for strategic transformation and curriculum enhancement, not a reporting tool. We hope this tool helps bring meaningful transformation of our educational programs.</li>
              </ul>
            </div>
          </details>
        </div>
        <button class="modal-get-started-btn" onclick="hideWelcomeModal()">Get Started</button>
      </div>
    </div>
  </div>

  <!-- Top Bar for SDG Icons -->
  <div id="top-bar">
      <div class="sdg-icons-list" id="sdgIconsList">
        <div class="sdg-icon-item" data-sdg="1">
          <img src="assets/images/logo/E Inverted Icons_WEB-01.png" alt="SDG 1 - No Poverty" />
        </div>
        <div class="sdg-icon-item" data-sdg="2">
          <img src="assets/images/logo/E Inverted Icons_WEB-02.png" alt="SDG 2 - Zero Hunger" />
        </div>
        <div class="sdg-icon-item" data-sdg="3">
          <img src="assets/images/logo/E Inverted Icons_WEB-03.png" alt="SDG 3 - Good Health" />
        </div>
        <!-- Quality Education icon hidden as requested
        <div class="sdg-icon-item" data-sdg="4">
          <img src="assets/images/logo/E Inverted Icons_WEB-04.png" alt="SDG 4 - Quality Education" />
        </div>
        -->
        <div class="sdg-icon-item" data-sdg="5">
          <img src="assets/images/logo/E Inverted Icons_WEB-05.png" alt="SDG 5 - Gender Equality" />
        </div>
        <div class="sdg-icon-item" data-sdg="6">
          <img src="assets/images/logo/E Inverted Icons_WEB-06.png" alt="SDG 6 - Clean Water" />
        </div>
        <div class="sdg-icon-item" data-sdg="7">
          <img src="assets/images/logo/E Inverted Icons_WEB-07.png" alt="SDG 7 - Clean Energy" />
        </div>
        <div class="sdg-icon-item" data-sdg="8">
          <img src="assets/images/logo/E Inverted Icons_WEB-08.png" alt="SDG 8 - Decent Work" />
        </div>
        <div class="sdg-icon-item" data-sdg="9">
          <img src="assets/images/logo/E Inverted Icons_WEB-09.png" alt="SDG 9 - Industry & Innovation" />
        </div>
        <div class="sdg-icon-item" data-sdg="10">
          <img src="assets/images/logo/E Inverted Icons_WEB-10.png" alt="SDG 10 - Reduced Inequalities" />
        </div>
        <div class="sdg-icon-item" data-sdg="11">
          <img src="assets/images/logo/E Inverted Icons_WEB-11.png" alt="SDG 11 - Sustainable Cities" />
        </div>
        <div class="sdg-icon-item" data-sdg="12">
          <img src="assets/images/logo/E Inverted Icons_WEB-12.png" alt="SDG 12 - Responsible Production" />
        </div>
        <div class="sdg-icon-item" data-sdg="13">
          <img src="assets/images/logo/E Inverted Icons_WEB-13.png" alt="SDG 13 - Climate Action" />
        </div>
        <div class="sdg-icon-item" data-sdg="14">
          <img src="assets/images/logo/E Inverted Icons_WEB-14.png" alt="SDG 14 - Life Below Water" />
        </div>
        <div class="sdg-icon-item" data-sdg="15">
          <img src="assets/images/logo/E Inverted Icons_WEB-15.png" alt="SDG 15 - Life on Land" />
        </div>
        <div class="sdg-icon-item" data-sdg="16">
          <img src="assets/images/logo/E Inverted Icons_WEB-16.png" alt="SDG 16 - Peace and Justice" />
        </div>
        <div class="sdg-icon-item" data-sdg="17">
          <img src="assets/images/logo/E Inverted Icons_WEB-17.png" alt="SDG 17 - Partnerships" />
        </div>
      </div>
      <!-- Separator -->
      <div class="top-bar-separator"></div>
      <!-- Search Container Removed from Top Bar -->
      <!-- Separator -->
      <div class="top-bar-separator"></div>
      <!-- Faculty Icons Removed -->
      <!-- No additional elements in top bar -->
  </div>

  <!-- Compact Visualization Icons REMOVED -->

  <!-- Main Content Area -->
  <div id="main-content">
    <!-- Plot Area -->
    <div id="plot-container">
      <div class="tabs-container">
        <button class="tab-button" data-tab-target="#tab3Content">
          <img src="assets/images/sdg_kg.png" alt="Donut chart icon" class="tab-button-icon" /> University Goals
        </button>
        <button class="tab-button" data-tab-target="#tab4Content">
          <img src="assets/images/sdg_kg.png" alt="Treemap icon" class="tab-button-icon" /> University Targets
        </button>
        <button class="tab-button active" data-tab-target="#tab1Content">
          <img src="assets/svgs/heatmap.svg" alt="Heatmap icon" class="tab-button-icon" /> Specialisation Goals
        </button>
        <button class="tab-button" data-tab-target="#tab5Content">
          <img src="assets/images/sdg_kg.png" alt="Treemap icon" class="tab-button-icon" /> Specialisation Targets
        </button>
        <button class="tab-button" data-tab-target="#tab2Content">
          <img src="assets/svgs/bubble-chart.svg" alt="Bubble chart icon" class="tab-button-icon" /> SDG Breakdown
        </button>
        <button class="tab-button" data-tab-target="#tab6Content">
          <img src="assets/images/sdg_kg.png" alt="Treemap icon" class="tab-button-icon" /> Target Breakdown
        </button>
      </div>

      <div id="tab1Content" class="tab-content active">
        <div class="chart-container"> <!-- Re-using existing class for layout -->
          <div id="heatmap-div" class="chart-div"></div>
          <div id="radar-div" class="chart-div"></div> <!-- Lollipop chart -->
        </div>
      </div>

      <div id="tab2Content" class="tab-content">
        <h3 id="sdg-breakdown-title" class="chart-title"></h3>
        <div class="chart-container"> <!-- Re-using existing class for layout -->
          <div id="bubble-chart-div" class="chart-div"></div>
          <div id="treemap-div" class="chart-div"></div>
        </div>
      </div>

      <div id="tab3Content" class="tab-content">
        <div id="donut-chart-div" class="chart-div"></div>
      </div>

      <div id="tab4Content" class="tab-content">
        <div id="treemap-by-target-div" class="chart-div"></div>
      </div>

      <div id="tab5Content" class="tab-content">
        <div id="treemap-by-specialisation-target-div" class="chart-div"></div>
      </div>

      <div id="tab6Content" class="tab-content">
        <h3 id="target-breakdown-title" class="chart-title"></h3>
        <div id="treemap-by-target-breakdown-div" class="chart-div"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Bar -->
  <div id="bottom-bar">
    <!-- Version Toggle -->
    <div class="bottom-bar-item">
      <div id="versionToggleContainer" class="version-toggle-container">
        <div id="versionToggle" class="version-toggle state-3"> <!-- Set initial state to v4 -->
          <div class="toggle-labels">
            <span>v1</span>
            <span>v2</span>
            <span>v3</span>
            <span>v4</span>
          </div>
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>
    <div class="bottom-bar-separator"></div>
    <!-- Course Count -->
    <div class="bottom-bar-item">
      <p id="course-count" style="margin: 0;">Courses: 3417</p>
    </div>
    <div class="bottom-bar-separator"></div>
    <!-- Search Container Moved Here -->
    <div class="bottom-bar-item" id="bottom-bar-search-container-wrapper" style="flex-grow: 1; display: flex; justify-content: center;">
      <div class="search-container" id="middle-search-container" style="width: 50%; max-width: 400px; margin: 0;">
        <input type="text" id="disciplineSearch" placeholder="Search specialisations..." class="search-input">
        <div id="disciplineDropdown" class="dropdown-content">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
    <div class="bottom-bar-separator"></div>
    <!-- Visualization Buttons Moved Here -->
    <div class="bottom-bar-item" id="viz-controls-container"> <!-- Container for centering -->
        <div class="visualisation-icons bottom-bar-viz-icons"> <!-- Added class for specific styling -->
            <!-- Removed heatmapBtn -->
            <!-- Removed cumulativeBtn -->
            <!-- Removed radarBtn as lollipop chart will now be displayed alongside heatmap -->
            <!-- exportPNG button moved -->
        </div>
    </div>
    <!-- Separator and Theme Toggle Area -->
    <div class="bottom-bar-item" style="margin-left: auto; display: flex; align-items: center;">
      <button id="methodValidationHeatmapBtn" class="viz-button" style="margin-right: 8px;"> <!-- Added margin-right for spacing -->
          <img src="assets/svgs/method-validation-heatmap.svg" alt="Method Validation Heatmap" />
      </button>
      <button id="exportPNG" class="viz-button" style="margin-right: 8px;">
          <img src="assets/svgs/download-icon.svg" alt="Download" />
      </button>
      <div class="bottom-bar-separator" style="display: block; height: 20px; margin: 0 4px;"></div> <!-- Explicitly show separator -->
      <a href="https://github.com/fiacrerougieux/auto-sdg-mapping-dashboard" target="_blank" rel="noopener noreferrer" class="viz-button" style="margin-right: 8px;" title="View on GitHub">
        <img src="assets/svgs/github-icon.svg" alt="GitHub Repository" />
      </a>
      <div class="bottom-bar-separator" style="display: block; height: 20px; margin: 0 4px;"></div> <!-- Explicitly show separator -->
      <div id="themeToggleContainer" class="theme-toggle-container">
        <div id="themeToggle" class="theme-toggle light-mode"> <!-- Default to light mode -->
          <div class="theme-toggle-labels">
            <span>Light</span>
            <span>Dark</span>
          </div>
          <div class="theme-toggle-knob"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Method Validation Heatmap Modal -->
  <div class="modal-overlay" id="methodValidationModal">
    <div class="modal-content" style="max-width: 90vw; width: 80%;"> <!-- Wider modal -->
      <button class="close-modal" id="closeMethodValidationModalBtn">&times;</button>
      <h2>F1 Scores: Method Validation Benchmarking</h2>
      <div id="methodValidationHeatmapDiv" style="width: 100%; height: 75vh; overflow: auto;">
        <!-- Heatmap will be rendered here by heatmap.js -->
      </div>
    </div>
  </div>

  <!-- Main Script -->
  <script>
    // Function to adjust main content padding based on top and bottom bar heights
    function adjustMainContentPadding() {
      const topBar = document.getElementById('top-bar');
      const bottomBar = document.getElementById('bottom-bar');
      const mainContent = document.getElementById('main-content');
      const topBarHeight = topBar.offsetHeight;
      const bottomBarHeight = bottomBar.offsetHeight;
      
      // Set the top padding of main content to match the top bar height plus some extra space
      mainContent.style.paddingTop = (topBarHeight + 20) + 'px';
      
      // Set the bottom padding of main content to match the bottom bar height plus some extra space
      mainContent.style.paddingBottom = (bottomBarHeight + 20) + 'px';
      
      // Set CSS variables for the bar heights that can be used in media queries
      document.documentElement.style.setProperty('--top-bar-height', topBarHeight + 'px');
      document.documentElement.style.setProperty('--bottom-bar-height', bottomBarHeight + 'px');
      
      // Adjust plot container height if needed
      const plotContainer = document.getElementById('plot-container');
      if (window.innerWidth <= 768) {
        plotContainer.style.height = `calc(100vh - 30px - ${topBarHeight}px - ${bottomBarHeight}px)`;
      } else if (window.innerWidth <= 1024) {
        plotContainer.style.height = `calc(100vh - 35px - ${topBarHeight}px - ${bottomBarHeight}px)`;
      } else {
        plotContainer.style.height = `calc(100vh - 40px - ${topBarHeight}px - ${bottomBarHeight}px)`;
      }
    }

    // On-load Modal & Method Validation Modal
    function showWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'flex';
      // Add a small delay before adding the active class to trigger the animation
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);
    }
    function hideWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.classList.remove('active');
      // Wait for the animation to complete before hiding the modal
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    function switchToTab(tabId) {
      const tabButton = document.querySelector(`.tab-button[data-tab-target="${tabId}"]`);
      if (tabButton) {
        tabButton.click();
      }
      hideWelcomeModal();
    }

    // Show the modal once DOM content has loaded
    document.addEventListener('DOMContentLoaded', function () {
      showWelcomeModal();
      
      // Close modal when clicking outside the modal content
      const modal = document.getElementById('welcomeModal');
      modal.addEventListener('click', function(event) {
        // Check if the click was on the modal overlay (not on the modal content)
        if (event.target === modal) {
          hideWelcomeModal();
        }
      });
      
      // Optionally auto-open the disclaimer
      // toggleDisclaimer();
    });

    // Method Validation Modal Logic
    const methodValidationModal = document.getElementById('methodValidationModal');
    const methodValidationHeatmapBtn = document.getElementById('methodValidationHeatmapBtn');
    const closeMethodValidationModalBtn = document.getElementById('closeMethodValidationModalBtn');

    function showMethodValidationModal() {
      methodValidationModal.style.display = 'flex';
      setTimeout(() => {
        methodValidationModal.classList.add('active');
        // Ensure createMethodValidationHeatmap is defined in heatmap.js
        if (typeof createMethodValidationHeatmap === 'function') {
          createMethodValidationHeatmap('methodValidationHeatmapDiv');
        } else {
          console.error('createMethodValidationHeatmap function not found.');
          document.getElementById('methodValidationHeatmapDiv').innerHTML = '<p style="color: red; text-align: center;">Error: Heatmap generation function is missing.</p>';
        }
      }, 10);
    }

    function hideMethodValidationModal() {
      methodValidationModal.classList.remove('active');
      setTimeout(() => {
        methodValidationModal.style.display = 'none';
        // Optional: Clear the heatmap div when modal is closed to free resources
        // document.getElementById('methodValidationHeatmapDiv').innerHTML = '';
      }, 300);
    }

    if (methodValidationHeatmapBtn) {
      methodValidationHeatmapBtn.addEventListener('click', showMethodValidationModal);
    }
    if (closeMethodValidationModalBtn) {
      closeMethodValidationModalBtn.addEventListener('click', hideMethodValidationModal);
    }
    if (methodValidationModal) {
      methodValidationModal.addEventListener('click', function(event) {
        if (event.target === methodValidationModal) {
          hideMethodValidationModal();
        }
      });
    }

    // Toggle sidebar disclaimer
    function toggleSidebarDisclaimer() {
      const content = document.getElementById('sidebarDisclaimerContent');
      const button = document.querySelector('.disclaimer-button');
      if (content.style.display === '' || content.style.display === 'block') {
        content.style.display = 'none';
        button.innerHTML = '‚ñº Disclaimer';
        button.classList.remove('active');
      } else {
        content.style.display = 'block';
        button.innerHTML = '‚ñ≤ Disclaimer';
        button.classList.add('active');
      }
    }

    // Function to parse a CSV line respecting quotes
    function parseCsvLine(line, delimiter = ',') {
        const values = [];
        let currentVal = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];

            if (char === '"') {
                // Handle quotes: toggle inQuotes state or handle escaped quotes ("")
                if (inQuotes && line[i + 1] === '"') {
                    currentVal += '"'; // Escaped quote
                    i++; // Skip next quote
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                // End of a value
                // Trim quotes only if they are at the very start and end of the value
                const trimmedVal = currentVal.trim();
                if (trimmedVal.startsWith('"') && trimmedVal.endsWith('"')) {
                    values.push(trimmedVal.substring(1, trimmedVal.length - 1).replace(/""/g, '"'));
                } else {
                    values.push(trimmedVal);
                }
                currentVal = '';
            } else {
                // Regular character
                currentVal += char;
            }
        }
        // Add the last value, handling potential quotes
        const trimmedVal = currentVal.trim();
        if (trimmedVal.startsWith('"') && trimmedVal.endsWith('"')) {
            values.push(trimmedVal.substring(1, trimmedVal.length - 1).replace(/""/g, '"'));
        } else {
            values.push(trimmedVal);
        }
        return values;
    }


    // Toggle sidebar REMOVED

    // ---------- Data & Visualization Logic -----------
    let currentDiscipline = 'ALL';
    let currentFaculty = 'ALL';
    let currentChartType = 'heatmap'; // Default active viz (within Tab 1)
    let previousChartType = null;
    const dataSources = [
      'data/sdg_analysis_llm_match.csv',      // v1
      'data/sdg_analysis_llm.csv',            // v2
      'data/sdg_analysis_llm_with_targets_and_names.csv', // v3
      'data/sdg_analysis_llm_with_targets_v4.csv' // v4
    ];
    const dataSourceLabels = [
      'Data: v1 (Match)',
      'Data: v2 (LLM)',
      'Data: v3 (LLM+Targets)',
      'Data: v4 (LLM+Targets Intensity)'
    ];
    let currentDataSourceIndex = 3; // Start with v4 (index 3)
    let currentDataFile = dataSources[currentDataSourceIndex];
    let currentSDG = 10; // default SDG (updated when user clicks an SDG icon)
    let currentTargetId = null; // To store the selected target ID

    let constants = {};
    let courseNameData = {}; // To store the course code to name mapping

    async function loadCourseNameMapping() {
      try {
        const response = await fetch('data/course_code_name_mapping.csv');
        const csvText = await response.text();
        const lines = csvText.split('\n').slice(1); // Skip header
        const mapping = {};
        lines.forEach(line => {
          if (line.trim()) {
            const parts = parseCsvLine(line); // Use existing robust parser
            if (parts.length >= 2) {
              mapping[parts[0].trim()] = parts[1].trim();
            }
          }
        });
        courseNameData = mapping;
        // Also add it to the global constants object for treemap.js
        if (window.constants) {
          window.constants.courseCodeNameMapping = mapping;
        }
        console.log("Course name mapping loaded:", Object.keys(courseNameData).length, "entries");
      } catch (error) {
        console.error('Error loading course name mapping:', error);
        courseNameData = {}; // Ensure it's an empty object on error
        // Also ensure the constants object has an empty mapping
        if (window.constants) {
          window.constants.courseCodeNameMapping = {};
        }
      }
    }

    async function loadConstants() {
      try {
        const response = await fetch('data/constants.json');
        constants = await response.json();
        window.constants = constants; // Make constants globally available
        window.sdgNames = constants.sdgNames; // Make sdgNames globally available as before
      } catch (error) {
        console.error('Error loading constants:', error);
      }
    }

    window.addEventListener('resize', function () {
      // Generic resize handler for Plotly charts if needed, targeting the visible one.
      // D3 resize needs to be handled within bubblechart.js if required.
      const activeTabContent = document.querySelector('.tab-content.active');
      if (!activeTabContent) return;

      if (activeTabContent.id === 'tab1Content') {
        const heatmapDiv = document.getElementById('heatmap-div');
        const radarDiv = document.getElementById('radar-div'); // Lollipop
        if (heatmapDiv && heatmapDiv.offsetParent !== null) Plotly.Plots.resize(heatmapDiv);
        if (radarDiv && radarDiv.offsetParent !== null) Plotly.Plots.resize(radarDiv);
      } else if (activeTabContent.id === 'tab2Content') {
        // Bubble chart (D3) resize should be handled in bubblechart.js if needed
        // For now, we call handleResize which will redraw it.
      }
    });

    // Load CSV data
    async function loadData() {
      try {
        const response = await fetch(currentDataFile);
        const csvText = await response.text();
        const lines = csvText.split('\n');

        if (lines.length === 0) {
          console.error('CSV file is empty.');
          return [];
        }

        const headerLine = lines[0];
        let delimiter = ',';
        if (headerLine.split('\t').length > headerLine.split(',').length) {
          delimiter = '\t';
        }

        const headers = headerLine.split(delimiter).map(header => header.trim().replace(/^"(.+)"$/, '$1'));
        
        const getColumnIndex = (columnName, isOptional = false) => {
          const lowerCaseColumnName = columnName.toLowerCase();
          const index = headers.findIndex(h => h.toLowerCase() === lowerCaseColumnName);
          if (index === -1 && !isOptional) {
            // console.warn(`Required column "${columnName}" not found. Available headers:`, headers.join(', '));
          }
          return index;
        };

        const colIndices = {
          course_code: getColumnIndex('course_code'),
          sdg_number: getColumnIndex('sdg_number'),
          sdg_name: getColumnIndex('sdg_name'),
          addressed: getColumnIndex('addressed', true), // Make optional
          alignment: getColumnIndex('alignment', true), // Add alignment as optional
          justification: getColumnIndex('justification', true),
          timestamp: getColumnIndex('timestamp', true),
          target_number: getColumnIndex('target_number', true),
          target_name: getColumnIndex('target_name', true),
          course_name: getColumnIndex('course_name', true)
        };

        // Check for essential columns, allowing for either 'addressed' or 'alignment'
        const hasAddressedOrAlignment = colIndices.addressed !== -1 || colIndices.alignment !== -1;
        const essentialColumns = ['course_code', 'sdg_number', 'sdg_name'];
        const missingEssentialColumns = essentialColumns.filter(col => colIndices[col] === -1);
        if (!hasAddressedOrAlignment) {
          missingEssentialColumns.push('addressed/alignment');
        }

        if (missingEssentialColumns.length > 0) {
          console.error(`Missing essential columns in CSV: ${missingEssentialColumns.join(', ')}`);
          return [];
        }

        const data = lines.slice(1).map(line => {
          if (!line.trim()) return null;
          const values = parseCsvLine(line, delimiter);

          if (values.length !== headers.length) {
              console.warn(`Skipping line due to mismatched columns: ${line}`);
              return null;
          }

          // Determine the value for addressed/alignment based on which column exists
          let addressedValue = '';
          if (colIndices.alignment !== -1) {
            addressedValue = (values[colIndices.alignment] || '').toLowerCase();
          } else if (colIndices.addressed !== -1) {
            addressedValue = (values[colIndices.addressed] || '').toLowerCase();
          }

          const rowData = {
            course_code: values[colIndices.course_code] || '',
            sdg_number: parseInt(values[colIndices.sdg_number]) || 0,
            sdg_name: values[colIndices.sdg_name] || '',
            addressed: addressedValue === 'yes' ||
                       addressedValue === 'supported' ||
                       addressedValue === 'focus' ||
                       addressedValue === 'strong' ||
                       addressedValue === 'moderate' ||
                       addressedValue === 'weak',
            alignment: addressedValue, // Keep the original value for coloring
            justification: values[colIndices.justification] || '',
            timestamp: values[colIndices.timestamp] || '',
            course_name: (colIndices.course_name !== -1 && values[colIndices.course_name]) ? values[colIndices.course_name] : ''
          };

          if (colIndices.target_number !== -1 && values[colIndices.target_number] !== undefined) {
            rowData.target_number = values[colIndices.target_number];
          }
          if (colIndices.target_name !== -1 && values[colIndices.target_name] !== undefined) {
            rowData.target_name = values[colIndices.target_name];
          }
          return rowData;
        }).filter(row => row && row.course_code);

        const disc = getDisciplines(data, currentFaculty);
        const dropdown = document.getElementById('disciplineDropdown');
        if (!currentDiscipline || !disc.includes(currentDiscipline)) {
          currentDiscipline = disc[0] || 'ALL';
        }
        
        dropdown.innerHTML = '';
        const allItem = document.createElement('div');
        allItem.className = 'dropdown-item' + (currentDiscipline === 'ALL' ? ' active' : '');
        allItem.setAttribute('data-value', 'ALL');
        allItem.textContent = 'All Specialisations';
        dropdown.appendChild(allItem);
        
        disc.forEach(d => {
          const item = document.createElement('div');
          item.className = 'dropdown-item' + (d === currentDiscipline ? ' active' : '');
          item.setAttribute('data-value', d);
          item.textContent = constants.specializationNames[d] || d;
          dropdown.appendChild(item);
        });
        
        setupDisciplineSearch();
        setupModalDisciplineSearch(disc);

        return data;
      } catch (error) {
        console.error('Error loading data:', error);
        return [];
      }
    }

    function updateCourseCount(data) {
      const uniqueCourses = new Set(data.map(row => row.course_code));
      document.getElementById('course-count').innerHTML =
        `Courses: <strong>${uniqueCourses.size}</strong>`;
    }

    function getDisciplines(data, selectedFaculty = 'ALL') {
      const disciplines = new Set(
        data.filter(row => {
          const d = row.course_code.substring(0, 4);
          return (selectedFaculty === 'ALL' || constants.facultyMapping[d] === selectedFaculty);
        }).map(row => row.course_code.substring(0, 4))
      );
      return Array.from(disciplines).sort();
    }

    function getCourseYear(courseCode) {
      const yearNum = parseInt(courseCode.charAt(4));
      return yearNum >= 5 ? 4 : yearNum;
    }

    function filterDataByDiscipline(data, discipline) {
      return data.filter(row => {
        const rowDiscipline = row.course_code.substring(0, 4);
        const rowFaculty = constants.facultyMapping[rowDiscipline];
        if (currentFaculty !== 'ALL' && rowFaculty !== currentFaculty) {
          return false;
        }
        return (discipline === 'ALL') ? true : (rowDiscipline === discipline);
      });
    }

    function downloadPNG(vizTypeToDownload, filename = null) {
      let svg;
      let targetDivId;
      let chartNameForFile = vizTypeToDownload; // Default

      if (vizTypeToDownload === 'bubble') {
        targetDivId = '#bubble-chart-div';
        chartNameForFile = `sdg${currentSDG}_bubble_chart`;
      } else if (vizTypeToDownload === 'heatmap' || vizTypeToDownload === 'cumulative') {
        targetDivId = '#heatmap-div';
        chartNameForFile = vizTypeToDownload === 'cumulative' ? 'sdg_cumulative_heatmap' : 'sdg_heatmap';
      } else if (vizTypeToDownload === 'lollipop') { // Explicitly 'lollipop'
        targetDivId = '#radar-div'; // Lollipop is in radar-div
        chartNameForFile = 'sdg_lollipop';
      } else if (vizTypeToDownload === 'donut') {
        targetDivId = '#donut-chart-div';
        chartNameForFile = 'university_profile_donut';
      } else if (vizTypeToDownload === 'treemap') {
        targetDivId = '#treemap-div';
        chartNameForFile = 'sdg_treemap';
      } else if (vizTypeToDownload === 'target-treemap') {
        targetDivId = '#treemap-by-target-div';
        chartNameForFile = 'university_targets_treemap';
      } else {
        console.error(`Unknown vizType for download: ${vizTypeToDownload}`);
        return;
      }
      
      svg = document.querySelector(`${targetDivId} svg`);
      
      if (!svg) {
        console.error(`No SVG found for visualization type: ${vizTypeToDownload} in ${targetDivId}`);
        // Attempt to draw if not found, then try download again (simple case)
        // This might be too complex for a generic download function.
        // For now, just log error.
        return;
      }
      
      const clonedSvg = svg.cloneNode(true);
      
      if (vizTypeToDownload === 'heatmap' || vizTypeToDownload === 'cumulative') {
        const rects = clonedSvg.querySelectorAll('rect.sdg-cell');
        
        rects.forEach(rect => {
          const value = parseFloat(rect.getAttribute('data-value') || '0');
          if (value > 0) {
            if (vizTypeToDownload === 'cumulative') {
              const courses = clonedSvg.querySelectorAll('rect.sdg-cell[data-course]');
              const uniqueCourses = new Set();
              courses.forEach(c => uniqueCourses.add(c.getAttribute('data-course')));
              const coursesLength = uniqueCourses.size;
              const intensity = value / (coursesLength * 0.5);
              const alpha = Math.min(0.3 + intensity * 0.7, 1);
              rect.setAttribute('fill', `rgba(0, 123, 255, ${alpha})`);
            } else {
              // For regular heatmap, preserve the existing colors that are already applied
              // The colors are already set correctly by the heatmap creation function
              // so we don't need to override them - just leave them as they are
              // This preserves the alignment-based colors (strong, moderate, weak)
            }
          }
        });
      }
      
      let svgData = new XMLSerializer().serializeToString(clonedSvg);
      if (!svgData.includes('xmlns="http://www.w3.org/2000/svg"')) {
        svgData = svgData.replace(/<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }

      const scaleFactor = 2;
      const canvas = document.createElement('canvas');
      const box = svg.getBoundingClientRect();
      canvas.width = box.width * scaleFactor;
      canvas.height = box.height * scaleFactor;

      const img = new Image();
      const blob = new Blob([svgData], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      
      img.onload = () => {
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.scale(scaleFactor, scaleFactor);
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = 1.0;
        ctx.drawImage(img, 0, 0, box.width, box.height);
        
        if (!filename) {
          const disciplineText = currentDiscipline === 'ALL' ? 'all_disciplines' : currentDiscipline;
          const facultyText = currentFaculty === 'ALL' ? 'all_faculties' : currentFaculty;
          filename = `${chartNameForFile}_${disciplineText}_${facultyText}.png`;
        }
        
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); // Clean up blob URL
      };
      img.onerror = () => {
        console.error("Error loading SVG image for download.");
        URL.revokeObjectURL(url);
      }
      img.src = url;
    }

    function downloadActivePlot() {
      const activeTabContent = document.querySelector('.tab-content.active');
      if (!activeTabContent) {
        console.error("No active tab found for download.");
        return;
      }

      if (activeTabContent.id === 'tab1Content') {
        // Determine if heatmap or cumulative is active for download
        const activeVizButton = document.querySelector('#bottom-bar .visualisation-icons .viz-button.active');
        if (activeVizButton && activeVizButton.id === 'cumulativeBtn') {
          downloadPNG('cumulative');
        } else {
          downloadPNG('heatmap');
        }
        // Optionally, also download lollipop if it's always paired
        // downloadPNG('lollipop'); 
      } else if (activeTabContent.id === 'tab2Content') {
        if (currentChartType === 'treemap') {
          downloadPNG('treemap');
        } else {
          downloadPNG('bubble');
        }
      } else if (activeTabContent.id === 'tab3Content') {
        downloadPNG('donut');
      } else if (activeTabContent.id === 'tab4Content') {
        downloadPNG('target-treemap');
      }
    }
    // Update event listener for the export button to download only the active plot
    document.getElementById('exportPNG').addEventListener('click', downloadActivePlot);


    const versionToggle = document.getElementById('versionToggle');
    versionToggle.addEventListener('click', function () {
      currentDataSourceIndex = (currentDataSourceIndex + 1) % dataSources.length;
      currentDataFile = dataSources[currentDataSourceIndex];
      this.classList.remove('state-0', 'state-1', 'state-2', 'state-3');
      this.classList.add(`state-${currentDataSourceIndex}`);
      console.log(`Switched data source to: ${currentDataFile} (State: ${currentDataSourceIndex})`);

      loadData().then(data => {
        updateCourseCount(data);
        // Redraw charts in the active tab
        const activeTabContent = document.querySelector('.tab-content.active');
        if (activeTabContent) {
            if (activeTabContent.id === 'tab1Content') {
                createBarChart(data, courseNameData);
                createHeatmap(data, false, courseNameData);
            } else if (activeTabContent.id === 'tab2Content') {
                // Always create both charts for tab2
                createBubbleChart(data, currentSDG, true); // Animate on data source change for bubble
                createTreemap(data, courseNameData, currentSDG);
            } else if (activeTabContent.id === 'tab3Content') {
                createDonutChart(data, true);
            } else if (activeTabContent.id === 'tab4Content') {
                createTargetTreemap(data);
            } else if (activeTabContent.id === 'tab5Content') {
                createSpecialisationTargetTreemap(data);
            }
        }
      });
    });

    // Event listeners for heatmapBtn and cumulativeBtn are removed as the buttons are removed.
    // setActiveVizButton function is also removed as it's no longer needed.

    function setupDisciplineSearch() {
      const searchInput = document.getElementById('disciplineSearch');
      const dropdown = document.getElementById('disciplineDropdown');
      
      // Event listeners for searchInput and dropdown items
      // ... (existing setupDisciplineSearch logic) ...
      // Ensure that when a discipline is selected, it redraws the
      // charts in the *currently active tab*.

      // Modify the click handler for dropdown items:
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.removeEventListener('click', handleDisciplineSelection); // Remove old listener if any
        item.addEventListener('click', handleDisciplineSelection);
      });

      function handleDisciplineSelection() {
        const selectedValue = this.getAttribute('data-value');
        const selectedText = this.textContent;
        
        searchInput.value = selectedText;
        dropdown.querySelectorAll('.dropdown-item').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
        dropdown.classList.remove('show');
        
        if (currentDiscipline !== selectedValue) {
          currentDiscipline = selectedValue;
          
          // Function to render the default view for Specialisation Goals
          const renderSpecialisationView = () => {
            loadData().then(data => {
                createBarChart(data, courseNameData);
              createHeatmap(data, false, courseNameData); // Always show normal heatmap after lollipop
            });
          };

          // If we are on the "Specialisation Targets" tab, just update it.
          if (activeTabId === '#tab5Content') {
            loadData().then(data => {
              createSpecialisationTargetTreemap(data);
            });
          } else {
            // Otherwise, switch to the "Specialisation Goals" tab
            const specialisationTabButton = document.querySelector('.tab-button[data-tab-target="#tab1Content"]');
            if (specialisationTabButton && !specialisationTabButton.classList.contains('active')) {
              specialisationTabButton.click(); // This will trigger the redraw
            } else {
              // If already on the Specialisation Goals tab, just redraw it
              loadData().then(data => {
                createBarChart(data, courseNameData);
                createHeatmap(data, false, courseNameData);
              });
            }
          }
        }
      }
      // ... (rest of existing setupDisciplineSearch logic for focus, input, document click)
       // Show dropdown when input is focused
      searchInput.addEventListener('focus', function() {
        dropdown.classList.add('show');
      });
      
      // Filter dropdown items as user types
      searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        let hasVisibleItems = false;
        const currentDropdownItems = dropdown.querySelectorAll('.dropdown-item:not(.no-results)');

        currentDropdownItems.forEach(item => {
          const itemText = item.textContent.toLowerCase();
          const shouldShow = itemText.includes(searchText);
          item.style.display = shouldShow ? 'block' : 'none';
          if (shouldShow) hasVisibleItems = true;
        });
        
        const noResultsMessage = dropdown.querySelector('.no-results');
        if (!hasVisibleItems && searchText) {
          if (!noResultsMessage) {
            const noResults = document.createElement('div');
            noResults.className = 'dropdown-item no-results';
            noResults.textContent = 'No matching specialisations found';
            noResults.style.fontStyle = 'italic';
            noResults.style.color = '#999';
            dropdown.appendChild(noResults);
          }
        } else {
          if (noResultsMessage) dropdown.removeChild(noResultsMessage);
        }
      });
       // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !dropdown.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });
      
      // Set initial search input value based on current discipline
      const activeDisciplineItem = dropdown.querySelector(`.dropdown-item[data-value="${currentDiscipline}"]`);
      if (activeDisciplineItem) {
        searchInput.value = activeDisciplineItem.textContent;
      }
    }

    function setupModalDisciplineSearch(disciplines) {
      const modalSearchInput = document.getElementById('modalDisciplineSearch');
      const modalDropdown = document.getElementById('modalDisciplineDropdown');
      modalDropdown.innerHTML = ''; // Clear previous

      const allItem = document.createElement('div');
      allItem.className = 'dropdown-item';
      allItem.setAttribute('data-value', 'ALL');
      allItem.textContent = 'All Specialisations';
      modalDropdown.appendChild(allItem);

      disciplines.forEach(d => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('data-value', d);
        item.textContent = constants.specializationNames[d] || d;
        modalDropdown.appendChild(item);
      });

      // Modify the click handler for modal dropdown items:
      modalDropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.removeEventListener('click', handleModalDisciplineSelection); // Remove old listener
        item.addEventListener('click', handleModalDisciplineSelection);
      });

      function handleModalDisciplineSelection() {
        const selectedValue = this.getAttribute('data-value');
        const selectedText = this.textContent;

        // Update global state
        currentDiscipline = selectedValue;

        // Update UI elements related to main search
        document.getElementById('disciplineSearch').value = selectedText;
        document.querySelectorAll('#disciplineDropdown .dropdown-item').forEach(el => el.classList.remove('active'));
        const mainActiveItem = document.querySelector(`#disciplineDropdown .dropdown-item[data-value="${selectedValue}"]`);
        if (mainActiveItem) mainActiveItem.classList.add('active');
        
        // Close modal UI
        modalDropdown.classList.remove('show');
        hideWelcomeModal();

        // Ensure Tab 1 is visually and logically the active tab
        const tab1Button = document.querySelector('.tab-button[data-tab-target="#tab1Content"]');
        if (!tab1Button.classList.contains('active')) {
            // Deactivate all other tab buttons and content
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Activate Tab 1 button and content
            tab1Button.classList.add('active');
            document.getElementById('tab1Content').classList.add('active');
        }
        activeTabId = '#tab1Content'; // Set global activeTabId

        // Now, load data and redraw charts for Tab 1 with the new currentDiscipline
        loadData().then(data => {
            const isCumulative = false; // Assuming cumulative feature is not primary as buttons are removed
            currentChartType = 'heatmap'; // Explicitly set for Tab 1 context

            createHeatmap(data, isCumulative, courseNameData);
            createBarChart(data, courseNameData);
            if (!isCumulative) { // Redraw non-cumulative heatmap if that's the default
                createHeatmap(data, false, courseNameData);
            }
            
            handleResize(); // Adjust layout as chart dimensions might change
        }).catch(error => {
            console.error('Error redrawing charts after modal selection:', error);
        });
      }
      // ... (rest of existing setupModalDisciplineSearch logic for focus, input, document click)
      modalSearchInput.addEventListener('focus', function() {
        modalDropdown.classList.add('show');
      });

      modalSearchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        let hasVisibleItems = false;
        const currentModalDropdownItems = modalDropdown.querySelectorAll('.dropdown-item:not(.no-results)');

        currentModalDropdownItems.forEach(item => {
          const itemText = item.textContent.toLowerCase();
          const shouldShow = itemText.includes(searchText);
          item.style.display = shouldShow ? 'block' : 'none';
          if (shouldShow) hasVisibleItems = true;
        });
        
        const noResultsMessage = modalDropdown.querySelector('.no-results');
        if (!hasVisibleItems && searchText) {
          if (!noResultsMessage) {
            const noResults = document.createElement('div');
            noResults.className = 'dropdown-item no-results';
            noResults.textContent = 'No matching specialisations found';
            noResults.style.fontStyle = 'italic';
            noResults.style.color = '#999';
            modalDropdown.appendChild(noResults);
          }
        } else {
           if (noResultsMessage) modalDropdown.removeChild(noResultsMessage);
        }
      });
      document.getElementById('welcomeModal').addEventListener('click', function(event) {
          if (!modalSearchInput.contains(event.target) && !modalDropdown.contains(event.target)) {
              modalDropdown.classList.remove('show');
          }
      });
    }

    const sdgIconsList = document.getElementById('sdgIconsList');
    sdgIconsList.querySelectorAll('.sdg-icon-item').forEach(item => {
      item.addEventListener('click', function () {
        sdgIconsList.querySelectorAll('.sdg-icon-item').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
        currentSDG = parseInt(this.getAttribute('data-sdg')) || 1;
        
        const titleEl = document.getElementById('sdg-breakdown-title');
        if (titleEl) {
            titleEl.textContent = `Breakdown for SDG ${currentSDG}: ${window.constants.sdgNames[currentSDG]}`;
        }

        const bubbleTabButton = document.querySelector('.tab-button[data-tab-target="#tab2Content"]');
        const isBubbleTabActive = bubbleTabButton.classList.contains('active');

        if (!isBubbleTabActive) {
          bubbleTabButton.click(); // This will trigger the tab switch and chart creation
        } else {
          // If bubble tab is already active, just reload its content
          loadData().then(data => {
            // Always update both charts in tab2
            createBubbleChart(data, currentSDG, true); // Animate on SDG change
            createTreemap(data, courseNameData, currentSDG);
          });
        }
      });
    });

    function populateSdgIcons(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = ''; // Clear existing icons

      for (let i = 1; i <= 17; i++) {
        if (i === 4) continue; // Skip SDG 4

        const iconItem = document.createElement('div');
        iconItem.className = 'sdg-icon-item';
        iconItem.setAttribute('data-sdg', i);

        const img = document.createElement('img');
        const imgNumber = i.toString().padStart(2, '0');
        img.src = `assets/images/logo/E Inverted Icons_WEB-${imgNumber}.png`;
        img.alt = `SDG ${i} - ${constants.sdgNames[i] || 'Unknown'}`;
        iconItem.appendChild(img);

        container.appendChild(iconItem);
      }
    }
    
    const modalSdgIconsList = document.getElementById('modalSdgIconsList');
    if (modalSdgIconsList) {
        modalSdgIconsList.addEventListener('click', function (event) {
            const iconItem = event.target.closest('.sdg-icon-item');
            if (!iconItem) return;

            const clickedSDG = parseInt(iconItem.getAttribute('data-sdg')) || 1;
            currentSDG = clickedSDG;

            // Update top bar icon state
            const topBarIcons = document.getElementById('sdgIconsList');
            if (topBarIcons) {
                topBarIcons.querySelectorAll('.sdg-icon-item').forEach(el => el.classList.remove('active'));
                const correspondingTopBarIcon = topBarIcons.querySelector(`.sdg-icon-item[data-sdg="${clickedSDG}"]`);
                if (correspondingTopBarIcon) correspondingTopBarIcon.classList.add('active');
            }

            hideWelcomeModal();

            // Switch to or update the SDG Breakdown tab
            const bubbleTabButton = document.querySelector('.tab-button[data-tab-target="#tab2Content"]');
            if (!bubbleTabButton.classList.contains('active')) {
                bubbleTabButton.click();
            } else {
                loadData().then(data => {
                    createBubbleChart(data, currentSDG, true);
                    createTreemap(data, courseNameData, currentSDG);
                });
            }
        });
    }

    function updateBottomBarVersions() {
      // This function seems to be for a different versioning UI, can be simplified or removed if not used
      // For ternary toggle, the state class handles visual update.
    }

    // ---------- Tab Switching Logic -----------
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    let activeTabId = '#tab1Content'; // Default active tab ID

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTabId = button.getAttribute('data-tab-target');
        if (activeTabId === targetTabId) return; // Do nothing if already active

        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        activeTabId = targetTabId;

        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === targetTabId.substring(1)) {
            content.classList.add('active');
          }
        });

        // Redraw charts in the newly active tab
        loadData().then(data => {
          if (activeTabId === '#tab1Content') {
            currentChartType = 'heatmap'; // Default to normal heatmap on tab switch
            createBarChart(data, courseNameData);
            createHeatmap(data, false, courseNameData);
          } else if (activeTabId === '#tab2Content') {
            const titleEl = document.getElementById('sdg-breakdown-title');
            if (titleEl) {
                titleEl.textContent = `Breakdown for SDG ${currentSDG}: ${window.constants.sdgNames[currentSDG]}`;
            }
            // Always create both charts for tab2
            createBubbleChart(data, currentSDG, false);
            createTreemap(data, courseNameData, currentSDG);
            currentChartType = 'bubble'; // Keep for compatibility
          } else if (activeTabId === '#tab3Content') {
            currentChartType = 'donut';
            createDonutChart(data, false);
          } else if (activeTabId === '#tab4Content') {
            currentChartType = 'target-treemap';
            createTargetTreemap(data);
          } else if (activeTabId === '#tab5Content') {
            currentChartType = 'specialisation-target-treemap';
            createSpecialisationTargetTreemap(data);
          } else if (activeTabId === '#tab6Content') {
            currentChartType = 'target-breakdown-treemap';
            createTargetBreakdownTreemap(data, currentTargetId);
          }
          handleResize(); // Adjust layout/size
        });
      });
    });

    // Initial load
    Promise.all([loadConstants(), loadCourseNameMapping()]).then(() => {
      loadData().then(data => {
        updateCourseCount(data);

        // Populate SDG icons in the modal
        populateSdgIcons('modalSdgIconsList');

        // Default to Tab 1 (Heatmap & Lollipop)
        document.querySelector('.tab-button[data-tab-target="#tab1Content"]').classList.add('active');
        document.getElementById('tab1Content').classList.add('active');
        activeTabId = '#tab1Content';
        currentChartType = 'heatmap'; // Initial chart type for tab 1

        createHeatmap(data, false, courseNameData);
        createBarChart(data, courseNameData);

        // Pre-load other charts
        createBubbleChart(data, currentSDG, false);
        createDonutChart(data, false);
        createTreemap(data, courseNameData, currentSDG);
        createTargetTreemap(data);
        createSpecialisationTargetTreemap(data);
        createTargetBreakdownTreemap(data, null); // Initial call for the new treemap

        // Set initial active SDG icon
        const topBarIcons = document.getElementById('sdgIconsList');
        if (topBarIcons) {
            const initialActiveIcon = topBarIcons.querySelector(`.sdg-icon-item[data-sdg="${currentSDG}"]`);
            if (initialActiveIcon) {
                initialActiveIcon.classList.add('active');
            }
        }
        
        adjustMainContentPadding();
        handleResize(); // Initial resize
      });
    });
    
    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
        var context = this, args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };

    const handleResize = debounce(function() {
      adjustMainContentPadding();
      loadData().then(data => {
        const currentActiveTab = document.querySelector('.tab-content.active');
        if (!currentActiveTab) return;

        if (currentActiveTab.id === 'tab1Content') {
          const activeHeatmapTypeButton = document.querySelector('#bottom-bar .visualisation-icons .viz-button.active');
          const isCumulative = activeHeatmapTypeButton && activeHeatmapTypeButton.id === 'cumulativeBtn';
          createHeatmap(data, isCumulative, courseNameData);
            createBarChart(data, courseNameData);
           if (!isCumulative) createHeatmap(data, false, courseNameData);
        } else if (currentActiveTab.id === 'tab2Content') {
            // Always update both charts in tab2
            createBubbleChart(data, currentSDG, false);
            createTreemap(data, courseNameData, currentSDG);
        } else if (currentActiveTab.id === 'tab3Content') {
          createDonutChart(data, false);
        } else if (currentActiveTab.id === 'tab4Content') {
          createTargetTreemap(data);
        } else if (currentActiveTab.id === 'tab5Content') {
          createSpecialisationTargetTreemap(data);
        } else if (currentActiveTab.id === 'tab6Content') {
            createTargetBreakdownTreemap(data, currentTargetId);
        }
      }).catch(error => {
        console.error("Error reloading data after resize:", error);
      });
    }, 250);

    window.addEventListener('resize', handleResize);
    window.addEventListener('load', adjustMainContentPadding); // Ensure padding is set on load too

    // Button event listeners removed - both charts now display side-by-side
  </script>

  <script>
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark-theme') {
      body.classList.add('dark-theme');
      themeToggle.classList.remove('light-mode');
      themeToggle.classList.add('dark-mode');
    }

    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark-theme');
      themeToggle.classList.toggle('light-mode');
      themeToggle.classList.toggle('dark-mode');

      if (body.classList.contains('dark-theme')) {
        localStorage.setItem('theme', 'dark-theme');
      } else {
        localStorage.removeItem('theme');
      }

      loadData().then(data => {
        const currentActiveTab = document.querySelector('.tab-content.active');
        if (!currentActiveTab) return;

        if (currentActiveTab.id === 'tab1Content') {
            const activeHeatmapTypeButton = document.querySelector('#bottom-bar .visualisation-icons .viz-button.active');
            const isCumulative = activeHeatmapTypeButton && activeHeatmapTypeButton.id === 'cumulativeBtn';
            createHeatmap(data, isCumulative, courseNameData);
            createBarChart(data, courseNameData);
            if (!isCumulative) createHeatmap(data, false, courseNameData);
        } else if (currentActiveTab.id === 'tab2Content') {
            if (currentChartType === 'treemap') {
                createTreemap(data, courseNameData, currentSDG);
            } else {
                createBubbleChart(data, currentSDG, false);
            }
        } else if (currentActiveTab.id === 'tab3Content') {
            createDonutChart(data, false);
        } else if (currentActiveTab.id === 'tab4Content') {
            createTargetTreemap(data);
        } else if (currentActiveTab.id === 'tab5Content') {
            createSpecialisationTargetTreemap(data);
        } else if (currentActiveTab.id === 'tab6Content') {
            createTargetBreakdownTreemap(data, currentTargetId);
        }
      }).catch(error => {
        console.error("Error reloading data after theme change:", error);
      });
    });
  </script>
</body>

</html>
