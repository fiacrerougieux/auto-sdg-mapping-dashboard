<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDG Analysis Dashboard</title>

  <!-- D3 and Plotly -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="radar.js?v=1.4"></script>
  <script src="heatmap.js?v=1.4"></script>
  <script src="bubblechart.js?v=1.4"></script>

  <link rel="stylesheet" href="style.css?v=1.4">
</head>

<body>
  <!-- Toggle Button for Sidebar on small screens -->
  <button id="toggle-sidebar">☰</button>

  <!-- INTRO MODAL (Explainer) -->
  <div class="modal-overlay" id="welcomeModal">
    <div class="modal-content">
      <button class="close-modal" onclick="hideWelcomeModal()">&times;</button>
      <h2>Welcome to the SDG Analysis Dashboard</h2>
      <p>
        This tool allows you to explore how university courses map to the UN Sustainable Development Goals (SDGs).
        <strong>Select an SDG</strong> on the left to view coverage across all specialisations (the "bubble chart").
      </p>
      <p>
        <strong>Or</strong>, pick a faculty and specialisation to see which courses in that area address each SDG (via
        a heatmap or cumulative chart). You can toggle between different visualisations (radar, heatmap, cumulative)
        under "Visualisation".
      </p>
      <p>
        Use the sidebar to switch between SDGs, faculties, and visualisation types. The disclaimer section below
        provides
        important info about how this data is generated.
      </p>
      <button onclick="hideWelcomeModal()">Get Started</button>
    </div>
  </div>

  <!-- Sidebar -->
  <div id="sidebar">
    <!-- Disclaimer Section (moved to top of sidebar) -->
    <div class="button-group">
      <button class="disclaimer-button" onclick="toggleSidebarDisclaimer()" style="padding: 2px 8px; margin: 0; line-height: 1; font-size: 0.85em;">
        ▼ Disclaimer
      </button>
      <div class="disclaimer-content" id="sidebarDisclaimerContent" style="display: none; padding: 10px; font-size: 0.9em;">
        <p>
          This visualization represents a high-level, automated mapping of UN Sustainable Development Goals
          (SDGs) across courses. Please note:
        </p>
        <ul>
          <li>This is an automated, preliminary analysis based solely on publicly available course information</li>
          <li>The mapping is likely incomplete and may contain inaccuracies</li>
          <li>Many course activities, assessments, and learning outcomes that address SDGs may not be captured</li>
          <li>This tool is not intended to replace detailed curriculum mapping efforts</li>
          <li>This visualization serves as a broad overview to complement more comprehensive manual assessment processes
          </li>
          <li>For accurate, detailed SDG mapping, please refer to official course documentation and detailed curriculum
            mapping initiatives</li>
          <li>This dashboard is provided as is with no guarantee of accuracy or completeness.</li>
          <li>We intend this mapping to be a genuine tool for strategic transformation and curriculum enhancement, not a reporting tool. We hope this tool helps bring meaningful transformation of our educational programs.</li>
        </ul>
      </div>
    </div>

    <div class="button-group">
      <h3 class="section-title">Analysis Data Source</h3>
      <div class="data-source-row">
        <div class="data-source-toggle">
          <div id="ternaryToggleContainer" class="ternary-toggle-container">
            <div id="ternaryToggle" class="ternary-toggle state-2"> <!-- Set initial state to v3 -->
              <div class="toggle-knob"></div>
            </div>
            <div class="toggle-labels">
              <span>v1</span>
              <span>v2</span>
              <span>v3</span>
            </div>
          </div>
        </div>
        <div class="course-count-container">
          <p id="course-count" style="font-size: 1.1em; color: #666; margin: 0;"></p>
        </div>
      </div>
    </div>

    <!-- Visualisation Icons -->
    <div class="button-group">
      <h3 class="section-title">Visualisation</h3>
      <div class="visualisation-icons">
        <button id="bubbleBtn" class="viz-button">
          <img src="visualisation/bubble-chart.svg" alt="Bubble Chart" />
        </button>
        <button id="heatmapBtn" class="viz-button active">
          <img src="visualisation/heatmap.svg" alt="Heatmap" />
        </button>
        <button id="cumulativeBtn" class="viz-button">
          <img src="visualisation/cumulative-heatmap.svg" alt="Cumulative Heatmap" />
        </button>
        <button id="radarBtn" class="viz-button">
          <img src="visualisation/radar-plot.svg" alt="Radar Chart" />
        </button>
        <button id="exportPNG" class="viz-button">
          <img src="visualisation/export-visualization.svg" alt="Export" />
        </button>
      </div>
    </div>

    <!-- SDG Icon Grid -->
    <div class="button-group">
      <h3 class="section-title">Percentage of SDG in specialisations</h3>
      <div class="sdg-icons-list" id="sdgIconsList">
        <div class="sdg-icon-item" data-sdg="1">
          <img src="logo/E Inverted Icons_WEB-01.png" alt="SDG 1 - No Poverty" />
        </div>
        <div class="sdg-icon-item" data-sdg="2">
          <img src="logo/E Inverted Icons_WEB-02.png" alt="SDG 2 - Zero Hunger" />
        </div>
        <div class="sdg-icon-item" data-sdg="3">
          <img src="logo/E Inverted Icons_WEB-03.png" alt="SDG 3 - Good Health" />
        </div>
        <!-- Quality Education icon hidden as requested
        <div class="sdg-icon-item" data-sdg="4">
          <img src="logo/E Inverted Icons_WEB-04.png" alt="SDG 4 - Quality Education" />
        </div>
        -->
        <div class="sdg-icon-item" data-sdg="5">
          <img src="logo/E Inverted Icons_WEB-05.png" alt="SDG 5 - Gender Equality" />
        </div>
        <div class="sdg-icon-item" data-sdg="6">
          <img src="logo/E Inverted Icons_WEB-06.png" alt="SDG 6 - Clean Water" />
        </div>
        <div class="sdg-icon-item" data-sdg="7">
          <img src="logo/E Inverted Icons_WEB-07.png" alt="SDG 7 - Clean Energy" />
        </div>
        <div class="sdg-icon-item" data-sdg="8">
          <img src="logo/E Inverted Icons_WEB-08.png" alt="SDG 8 - Decent Work" />
        </div>
        <div class="sdg-icon-item" data-sdg="9">
          <img src="logo/E Inverted Icons_WEB-09.png" alt="SDG 9 - Industry & Innovation" />
        </div>
        <div class="sdg-icon-item" data-sdg="10">
          <img src="logo/E Inverted Icons_WEB-10.png" alt="SDG 10 - Reduced Inequalities" />
        </div>
        <div class="sdg-icon-item" data-sdg="11">
          <img src="logo/E Inverted Icons_WEB-11.png" alt="SDG 11 - Sustainable Cities" />
        </div>
        <div class="sdg-icon-item" data-sdg="12">
          <img src="logo/E Inverted Icons_WEB-12.png" alt="SDG 12 - Responsible Production" />
        </div>
        <div class="sdg-icon-item" data-sdg="13">
          <img src="logo/E Inverted Icons_WEB-13.png" alt="SDG 13 - Climate Action" />
        </div>
        <div class="sdg-icon-item" data-sdg="14">
          <img src="logo/E Inverted Icons_WEB-14.png" alt="SDG 14 - Life Below Water" />
        </div>
        <div class="sdg-icon-item" data-sdg="15">
          <img src="logo/E Inverted Icons_WEB-15.png" alt="SDG 15 - Life on Land" />
        </div>
        <div class="sdg-icon-item" data-sdg="16">
          <img src="logo/E Inverted Icons_WEB-16.png" alt="SDG 16 - Peace and Justice" />
        </div>
        <div class="sdg-icon-item" data-sdg="17">
          <img src="logo/E Inverted Icons_WEB-17.png" alt="SDG 17 - Partnerships" />
        </div>
      </div>
    </div>


    <!-- By Faculty & Specialisation -->
    <div class="button-group">
      <h3 class="section-title">SDGs present in each course of specialisations</h3>
      <div class="faculty-icons-list" id="facultyIconsList">
        <div class="faculty-icon-item" data-faculty="ALL">
          <img src="faculty/all.svg" alt="All faculties" />
        </div>
        <div class="faculty-icon-item" data-faculty="ADA">
          <img src="faculty/ada.svg" alt="Arts, Design & Architecture" />
        </div>
        <div class="faculty-icon-item" data-faculty="BUSINESS">
          <img src="faculty/business.svg" alt="Business School" />
        </div>
        <div class="faculty-icon-item" data-faculty="ENG">
          <img src="faculty/engineering.svg" alt="Engineering" />
        </div>
        <div class="faculty-icon-item" data-faculty="LAW">
          <img src="faculty/law.svg" alt="Law & Justice" />
        </div>
        <div class="faculty-icon-item" data-faculty="MED">
          <img src="faculty/medicine.svg" alt="Medicine & Health" />
        </div>
        <div class="faculty-icon-item" data-faculty="SCIENCE">
          <img src="faculty/science.svg" alt="Science" />
        </div>
        <div class="faculty-icon-item" data-faculty="CANBERRA">
          <img src="faculty/canberra.svg" alt="UNSW Canberra" />
        </div>
      </div>
      <select id="disciplineSelect" class="switch-button" size="8">
        <!-- Populated by JS -->
      </select>
    </div>


    <!-- SDG Knowledge Graph Link -->
    <div class="button-group">
      <h3 class="section-title">Check our SDG knowledge graph below!</h3>
      <a href="https://fiacrerougieux.github.io/sdg_network_explorer/" target="_blank">
        <img src="other/sdg_network.png" alt="SDG Knowledge Graph" style="width: 100%; border-radius: 4px; margin-top: 10px;">
      </a>
    </div>
  </div>



  <!-- Main Content Area -->
  <div id="main-content">
    <!-- Plot Area -->
    <div id="plot-container">
      <div id="bubble-chart-div" class="chart-div" style="width: 100%; height: 100%; display: none;"></div>
      <div id="heatmap-div" class="chart-div" style="width: 100%; height: 100%; display: none;"></div>
      <div id="radar-div" class="chart-div" style="width: 100%; height: 100%; display: none;"></div>
      <!-- Cumulative heatmap will reuse #heatmap-div -->
    </div>
  </div>

  <!-- Main Script -->
  <script>
    // On-load Modal
    function showWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'flex';
      // Add a small delay before adding the active class to trigger the animation
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);
    }
    function hideWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.classList.remove('active');
      // Wait for the animation to complete before hiding the modal
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    // Show the modal once DOM content has loaded
    document.addEventListener('DOMContentLoaded', function () {
      showWelcomeModal();
      
      // Close modal when clicking outside the modal content
      const modal = document.getElementById('welcomeModal');
      modal.addEventListener('click', function(event) {
        // Check if the click was on the modal overlay (not on the modal content)
        if (event.target === modal) {
          hideWelcomeModal();
        }
      });
      
      // Optionally auto-open the disclaimer
      // toggleDisclaimer();
    });

    // Toggle sidebar disclaimer
    function toggleSidebarDisclaimer() {
      const content = document.getElementById('sidebarDisclaimerContent');
      const button = document.querySelector('.disclaimer-button');
      if (content.style.display === '' || content.style.display === 'block') {
        content.style.display = 'none';
        button.innerHTML = '▼ Disclaimer';
        button.classList.remove('active');
      } else {
        content.style.display = 'block';
        button.innerHTML = '▲ Disclaimer';
        button.classList.add('active');
      }
    }

    // Function to parse a CSV line respecting quotes
    function parseCsvLine(line, delimiter = ',') {
        const values = [];
        let currentVal = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];

            if (char === '"') {
                // Handle quotes: toggle inQuotes state or handle escaped quotes ("")
                if (inQuotes && line[i + 1] === '"') {
                    currentVal += '"'; // Escaped quote
                    i++; // Skip next quote
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                // End of a value
                // Trim quotes only if they are at the very start and end of the value
                const trimmedVal = currentVal.trim();
                if (trimmedVal.startsWith('"') && trimmedVal.endsWith('"')) {
                    values.push(trimmedVal.substring(1, trimmedVal.length - 1).replace(/""/g, '"'));
                } else {
                    values.push(trimmedVal);
                }
                currentVal = '';
            } else {
                // Regular character
                currentVal += char;
            }
        }
        // Add the last value, handling potential quotes
        const trimmedVal = currentVal.trim();
        if (trimmedVal.startsWith('"') && trimmedVal.endsWith('"')) {
            values.push(trimmedVal.substring(1, trimmedVal.length - 1).replace(/""/g, '"'));
        } else {
            values.push(trimmedVal);
        }
        return values;
    }


    // Toggle sidebar
    document.getElementById('toggle-sidebar').addEventListener('click', function () {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('main-content').classList.toggle('sidebar-active');
    });

    // ---------- Data & Visualization Logic -----------
    let currentDiscipline = 'ALL';
    let currentFaculty = 'ALL';
    let currentChartType = 'heatmap'; // Default active viz
    let previousChartType = null;
    const dataSources = [
      'sdg_analysis_llm_match.csv',      // v1
      'sdg_analysis_llm.csv',            // v2
      'sdg_analysis_llm_with_targets.csv' // v3
    ];
    const dataSourceLabels = [
      'Data: v1 (Match)',
      'Data: v2 (LLM)',
      'Data: v3 (LLM+Targets)'
    ];
    let currentDataSourceIndex = 2; // Start with v3 (index 2)
    let currentDataFile = dataSources[currentDataSourceIndex];
    let currentSDG = 1; // default SDG (updated when user clicks an SDG icon)

    let constants = {};

    async function loadConstants() {
      try {
        const response = await fetch('constants.json');
        constants = await response.json();
        window.sdgNames = constants.sdgNames; // Make sdgNames globally available as before
      } catch (error) {
        console.error('Error loading constants:', error);
      }
    }

    // Note: getPlotDimensions might need adjustment if called by D3 charts now,
    // as they target specific divs. Plotly handles its own resizing within its div.
    // D3 charts might need to get dimensions from their specific div if resize logic is added there.

    // Generic resize handler for Plotly charts if needed, targeting the visible one.
    // D3 resize needs to be handled within bubblechart.js if required.
    window.addEventListener('resize', function () {
      const activePlotlyDivId = currentChartType === 'heatmap' || currentChartType === 'cumulative' ? 'heatmap-div'
                              : currentChartType === 'radar' ? 'radar-div'
                              : null;
      if (activePlotlyDivId) {
        const container = document.getElementById(activePlotlyDivId);
        if (container && container.offsetParent !== null) { // Check if visible
          Plotly.Plots.resize(container);
        }
      }
      // If bubble chart needs resize handling, it should be added within bubblechart.js
      // listening to resize and redrawing based on #bubble-chart-div dimensions.
    });

    // Load CSV data
    async function loadData() {
      try {
        const response = await fetch(currentDataFile);
        const csvText = await response.text();
        const lines = csvText.split('\n');

        if (lines.length === 0) {
          console.error('CSV file is empty.');
          return [];
        }

        // Determine delimiter and column indices from header
        const headerLine = lines[0];
        let delimiter = ',';
        if (headerLine.split('\t').length > headerLine.split(',').length) {
          delimiter = '\t';
        }

        const headers = headerLine.split(delimiter).map(header => header.trim().replace(/^"(.+)"$/, '$1'));
        const getColumnIndex = (columnName) => headers.indexOf(columnName);

        const colIndices = {
          course_code: getColumnIndex('course_code'),
          sdg_number: getColumnIndex('sdg_number'),
          sdg_name: getColumnIndex('sdg_name'),
          addressed: getColumnIndex('addressed'),
          justification: getColumnIndex('justification'),
          timestamp: getColumnIndex('timestamp'),
          target_number: getColumnIndex('target_number'),
          target_name: getColumnIndex('target_name')
        };

        // Check if essential columns are present
        const essentialColumns = ['course_code', 'sdg_number', 'sdg_name', 'addressed', 'justification', 'timestamp'];
        const missingEssentialColumns = essentialColumns.filter(col => colIndices[col] === -1);

        if (missingEssentialColumns.length > 0) {
          console.error(`Missing essential columns in CSV: ${missingEssentialColumns.join(', ')}`);
          return [];
        }

        const data = lines.slice(1).map(line => {
          if (!line.trim()) return null; // Skip empty lines
          const values = parseCsvLine(line, delimiter); // Use the robust parser

          // Check if the number of values matches the number of headers
          if (values.length !== headers.length) {
              console.warn(`Skipping line due to mismatched columns: ${line}`);
              console.warn(`Expected ${headers.length} columns, found ${values.length}`);
              console.warn(`Values found:`, values);
              return null; // Skip this line
          }

          // No need for cleanValue anymore as parseCsvLine handles quotes
          const rowData = {
            course_code: values[colIndices.course_code] || '',
            sdg_number: parseInt(values[colIndices.sdg_number]) || 0,
            sdg_name: values[colIndices.sdg_name] || '',
            addressed: (values[colIndices.addressed] || '').toLowerCase() === 'yes' ||
                       (values[colIndices.addressed] || '').toLowerCase() === 'supported' ||
                       (values[colIndices.addressed] || '').toLowerCase() === 'focus',
            justification: values[colIndices.justification] || '',
            timestamp: values[colIndices.timestamp] || ''
          };

          // Include target information if columns exist
          if (colIndices.target_number !== -1 && values[colIndices.target_number] !== undefined) {
            rowData.target_number = values[colIndices.target_number];
          }
          if (colIndices.target_name !== -1 && values[colIndices.target_name] !== undefined) {
            rowData.target_name = values[colIndices.target_name];
          }

          return rowData;
        }).filter(row => row && row.course_code); // Filter out nulls and rows without course_code

        // Rebuild discipline select
        const disc = getDisciplines(data, currentFaculty);
        const select = document.getElementById('disciplineSelect');
        // If current discipline is not in the new list, reset it
        if (!currentDiscipline || !disc.includes(currentDiscipline)) {
          currentDiscipline = disc[0] || 'ALL';
        }
        select.innerHTML = disc.map(d =>
          `<option value="${d}" ${d === currentDiscipline ? 'selected' : ''}>
             ${constants.specializationNames[d] || d}
           </option>`
        ).join('');

        return data;
      } catch (error) {
        console.error('Error loading data:', error);
        return [];
      }
    }

    function updateCourseCount(data) {
      // Count all unique courses
      const uniqueCourses = new Set(data.map(row => row.course_code));
      document.getElementById('course-count').innerHTML =
        `Total Courses: <strong>${uniqueCourses.size}</strong>`;
    }

    function getDisciplines(data, selectedFaculty = 'ALL') {
      const disciplines = new Set(
        data.filter(row => {
          const d = row.course_code.substring(0, 4);
          return (selectedFaculty === 'ALL' || constants.facultyMapping[d] === selectedFaculty);
        }).map(row => row.course_code.substring(0, 4))
      );
      return Array.from(disciplines).sort();
    }

    function getCourseYear(courseCode) {
      const yearNum = parseInt(courseCode.charAt(4));
      return yearNum >= 5 ? 4 : yearNum;
    }

    // Heatmap & Radar code
    // Filter data by discipline & faculty
    function filterDataByDiscipline(data, discipline) {
      return data.filter(row => {
        const rowDiscipline = row.course_code.substring(0, 4);
        const rowFaculty = constants.facultyMapping[rowDiscipline];
        if (currentFaculty !== 'ALL' && rowFaculty !== currentFaculty) {
          return false;
        }
        return (discipline === 'ALL') ? true : (rowDiscipline === discipline);
      });
    }

    // Bubble Chart
    // PNG Export
    function downloadPNG() {
      const svg = document.querySelector('#plot-container svg');
      if (!svg) return;
      const svgData = new XMLSerializer().serializeToString(svg);

      const canvas = document.createElement('canvas');
      const box = svg.getBoundingClientRect();
      canvas.width = box.width;
      canvas.height = box.height;

      const img = new Image();
      const blob = new Blob([svgData], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);

      img.onload = () => {
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `sdg_distribution_${currentSDG}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
      img.src = url;
    }
    document.getElementById('exportPNG').addEventListener('click', downloadPNG);

    // Event Listener for Custom Ternary Toggle
    const ternaryToggle = document.getElementById('ternaryToggle');
    ternaryToggle.addEventListener('click', function () {
      currentDataSourceIndex = (currentDataSourceIndex + 1) % dataSources.length; // Cycle through 0, 1, 2
      currentDataFile = dataSources[currentDataSourceIndex];

      // Update toggle visual state
      this.classList.remove('state-0', 'state-1', 'state-2');
      this.classList.add(`state-${currentDataSourceIndex}`);

      console.log(`Switched data source to: ${currentDataFile} (State: ${currentDataSourceIndex})`); // Debugging log

      loadData().then(data => {
        updateCourseCount(data);
        redrawVisualization(data);
      });
    });

    function redrawVisualization(data) {
      const shouldAnimate = previousChartType === 'bubble' && currentChartType === 'bubble';
      // Which button is active?
      if (currentChartType === 'bubble') {
        createBubbleChart(data, currentSDG, shouldAnimate);
      } else if (currentChartType === 'radar') {
        createRadar(data);
      } else if (currentChartType === 'heatmap') {
        createHeatmap(data, false);
      } else if (currentChartType === 'cumulative') {
        createHeatmap(data, true);
      }
    }

    // Add event listeners to the visualization buttons in the left sidebar
    document.querySelector('#sidebar .visualisation-icons #bubbleBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'bubble');
      const shouldAnimate = previousChartType === 'bubble' && currentChartType === 'bubble';
      loadData().then(data => createBubbleChart(data, currentSDG, shouldAnimate));
    });
    document.querySelector('#sidebar .visualisation-icons #radarBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'radar');
      loadData().then(data => createRadar(data));
    });
    document.querySelector('#sidebar .visualisation-icons #heatmapBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'heatmap');
      loadData().then(data => createHeatmap(data, false));
    });
    document.querySelector('#sidebar .visualisation-icons #cumulativeBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'cumulative');
      loadData().then(data => createHeatmap(data, true));
    });
    document.querySelector('#sidebar .visualisation-icons #exportPNG').addEventListener('click', downloadPNG);

    function setActiveVizButton(btn, newChartType) {
      // Update chart type state
      previousChartType = currentChartType;
      currentChartType = newChartType;

      // Update active class visually
      document.querySelectorAll('#sidebar .visualisation-icons .viz-button').forEach(button => {
        button.classList.remove('active');
      });
      btn.classList.add('active');

      // Toggle visibility of chart divs
      document.querySelectorAll('.chart-div').forEach(div => {
        div.style.display = 'none';
      });
      let targetDivId;
      if (newChartType === 'bubble') {
        targetDivId = 'bubble-chart-div';
      } else if (newChartType === 'heatmap' || newChartType === 'cumulative') {
        targetDivId = 'heatmap-div'; // Both heatmaps use the same div
      } else if (newChartType === 'radar') {
        targetDivId = 'radar-div';
      }
      if (targetDivId) {
        document.getElementById(targetDivId).style.display = 'block';
      }
    }


    // Faculty icon clicks
    const facultyIconsList = document.getElementById('facultyIconsList');
    facultyIconsList.querySelectorAll('.faculty-icon-item').forEach(item => {
      item.addEventListener('click', function () {
        facultyIconsList.querySelectorAll('.faculty-icon-item').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
        currentFaculty = this.getAttribute('data-faculty');

        // If currently on bubble chart, switch to heatmap (default for faculty/discipline view)
        if (currentChartType === 'bubble') {
          // Manually trigger the heatmap button's logic without simulating a click
          const heatmapBtn = document.querySelector('#sidebar .visualisation-icons #heatmapBtn');
          setActiveVizButton(heatmapBtn, 'heatmap');
          loadData().then(data => createHeatmap(data, false));
        } else {
          // Otherwise, just reload the current visualization with the new faculty/discipline filter
          loadData().then(data => redrawVisualization(data));
        }
      });
    });

    // Discipline selection
    document.getElementById('disciplineSelect').addEventListener('change', function () {
      currentDiscipline = this.value;

      // If currently on bubble chart, switch to heatmap (default for faculty/discipline view)
      if (currentChartType === 'bubble') {
         // Manually trigger the heatmap button's logic without simulating a click
         const heatmapBtn = document.querySelector('#sidebar .visualisation-icons #heatmapBtn');
         setActiveVizButton(heatmapBtn, 'heatmap');
         loadData().then(data => createHeatmap(data, false));
      } else {
        // Otherwise, just reload the current visualization with the new faculty/discipline filter
        loadData().then(data => redrawVisualization(data));
      }
    });

    // SDG icon clicks
    const sdgIconsList = document.getElementById('sdgIconsList');
    sdgIconsList.querySelectorAll('.sdg-icon-item').forEach(item => {
      item.addEventListener('click', function () {
        sdgIconsList.querySelectorAll('.sdg-icon-item').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
        currentSDG = parseInt(this.getAttribute('data-sdg')) || 1;

        // Update state *before* calling setActiveVizButton
        previousChartType = currentChartType;
        currentChartType = 'bubble';

        // Switch to Bubble chart visually and functionally
        const bubbleBtn = document.querySelector('#sidebar .visualisation-icons #bubbleBtn');
        setActiveVizButton(bubbleBtn, 'bubble'); // This now correctly uses the updated previous/current types

        const shouldAnimate = previousChartType === 'bubble' && currentChartType === 'bubble';
        loadData().then(data => createBubbleChart(data, currentSDG, shouldAnimate));
      });
    });

    // Initial load
    loadConstants().then(() => {
      loadData().then(data => {
        updateCourseCount(data);
        // Default: binary heatmap is marked active and its div shown
        const heatmapBtn = document.querySelector('#sidebar .visualisation-icons #heatmapBtn');
        setActiveVizButton(heatmapBtn, 'heatmap'); // Set state and show div
        createHeatmap(data, false); // Draw into the now visible div
      });
    });
  </script>
</body>

</html>
