<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDG Analysis Dashboard</title>

  <!-- D3 and Plotly -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="radar.js?v=2.1"></script>
  <script src="heatmap.js?v=2.1"></script>
  <script src="bubblechart.js?v=2.1"></script>

  <link rel="stylesheet" href="style.css?v=2.1">
</head>

<body>
  <!-- Toggle Button for Sidebar on small screens -->
  <button id="toggle-sidebar">â˜°</button>

  <!-- INTRO MODAL (Explainer) -->
  <div class="modal-overlay" id="welcomeModal">
    <div class="modal-content">
      <button class="close-modal" onclick="hideWelcomeModal()">&times;</button>
      <h2>Welcome to the SDG Analysis Dashboard</h2>
      <p>
        This tool allows you to explore how university courses map to the UN Sustainable Development Goals (SDGs).
        <strong>Select an SDG</strong> on the top bar or below to view coverage across all specialisations (the "bubble chart"):
      </p>
      <div class="modal-sdg-icons">
        <div class="sdg-icons-list" id="modalSdgIconsList">
          <div class="sdg-icon-item" data-sdg="1">
            <img src="logo/E Inverted Icons_WEB-01.png" alt="SDG 1 - No Poverty" />
          </div>
          <div class="sdg-icon-item" data-sdg="2">
            <img src="logo/E Inverted Icons_WEB-02.png" alt="SDG 2 - Zero Hunger" />
          </div>
          <div class="sdg-icon-item" data-sdg="3">
            <img src="logo/E Inverted Icons_WEB-03.png" alt="SDG 3 - Good Health" />
          </div>
          <!-- Quality Education icon hidden as requested
          <div class="sdg-icon-item" data-sdg="4">
            <img src="logo/E Inverted Icons_WEB-04.png" alt="SDG 4 - Quality Education" />
          </div>
          -->
          <div class="sdg-icon-item" data-sdg="5">
            <img src="logo/E Inverted Icons_WEB-05.png" alt="SDG 5 - Gender Equality" />
          </div>
          <div class="sdg-icon-item" data-sdg="6">
            <img src="logo/E Inverted Icons_WEB-06.png" alt="SDG 6 - Clean Water" />
          </div>
          <div class="sdg-icon-item" data-sdg="7">
            <img src="logo/E Inverted Icons_WEB-07.png" alt="SDG 7 - Clean Energy" />
          </div>
          <div class="sdg-icon-item" data-sdg="8">
            <img src="logo/E Inverted Icons_WEB-08.png" alt="SDG 8 - Decent Work" />
          </div>
          <div class="sdg-icon-item" data-sdg="9">
            <img src="logo/E Inverted Icons_WEB-09.png" alt="SDG 9 - Industry & Innovation" />
          </div>
          <div class="sdg-icon-item" data-sdg="10">
            <img src="logo/E Inverted Icons_WEB-10.png" alt="SDG 10 - Reduced Inequalities" />
          </div>
          <div class="sdg-icon-item" data-sdg="11">
            <img src="logo/E Inverted Icons_WEB-11.png" alt="SDG 11 - Sustainable Cities" />
          </div>
          <div class="sdg-icon-item" data-sdg="12">
            <img src="logo/E Inverted Icons_WEB-12.png" alt="SDG 12 - Responsible Production" />
          </div>
          <div class="sdg-icon-item" data-sdg="13">
            <img src="logo/E Inverted Icons_WEB-13.png" alt="SDG 13 - Climate Action" />
          </div>
          <div class="sdg-icon-item" data-sdg="14">
            <img src="logo/E Inverted Icons_WEB-14.png" alt="SDG 14 - Life Below Water" />
          </div>
          <div class="sdg-icon-item" data-sdg="15">
            <img src="logo/E Inverted Icons_WEB-15.png" alt="SDG 15 - Life on Land" />
          </div>
          <div class="sdg-icon-item" data-sdg="16">
            <img src="logo/E Inverted Icons_WEB-16.png" alt="SDG 16 - Peace and Justice" />
          </div>
          <div class="sdg-icon-item" data-sdg="17">
            <img src="logo/E Inverted Icons_WEB-17.png" alt="SDG 17 - Partnerships" />
          </div>
        </div>
      </div>
      <p>
        <strong>Or</strong>, pick a faculty or search for a specialisation in the top bar or below to see which courses in that area address each SDG (via
        a heatmap or cumulative chart). You can toggle between different visualisations (radar, heatmap, cumulative)
        under "Visualisation".
      </p>
      <div class="modal-faculty-icons">
        <div class="faculty-icons-list" id="modalFacultyIconsList">
          <div class="faculty-icon-item" data-faculty="ADA">
            <img src="faculty/ada.svg" alt="Arts, Design & Architecture" />
          </div>
          <div class="faculty-icon-item" data-faculty="BUSINESS">
            <img src="faculty/business.svg" alt="Business School" />
          </div>
          <div class="faculty-icon-item" data-faculty="ENG">
            <img src="faculty/engineering.svg" alt="Engineering" />
          </div>
          <div class="faculty-icon-item" data-faculty="LAW">
            <img src="faculty/law.svg" alt="Law & Justice" />
          </div>
          <div class="faculty-icon-item" data-faculty="MED">
            <img src="faculty/medicine.svg" alt="Medicine & Health" />
          </div>
          <div class="faculty-icon-item" data-faculty="SCIENCE">
            <img src="faculty/science.svg" alt="Science" />
          </div>
          <div class="faculty-icon-item" data-faculty="CANBERRA">
            <img src="faculty/canberra.svg" alt="UNSW Canberra" />
          </div>
        </div>
      </div>
      <p>
        Use the sidebar to visualisation types.
      </p>
      <button onclick="hideWelcomeModal()">Get Started</button>
      <!-- Disclaimer Section (moved to modal) -->
      <div class="modal-disclaimer-content">
        <p>
          This visualization represents a high-level, automated mapping of UN Sustainable Development Goals
          (SDGs) across courses. Please note:
        </p>
        <ul>
          <li>This dashboard is provided "as is" and "as available" without any warranties of any kind, express or implied, including but not limited to warranties of merchantability, fitness for a particular purpose, or non-infringement. We make no guarantee regarding the accuracy, completeness, or reliability of the data or visualizations presented herein.</li>
          <li>This is an automated, preliminary analysis based solely on publicly available course information</li>
          <li>The mapping is likely incomplete and may contain inaccuracies</li>
          <li>Many course activities, assessments, and learning outcomes that address SDGs may not be captured</li>
          <li>This tool is not intended to replace detailed curriculum mapping efforts</li>
          <li>This visualization serves as a broad overview to complement more comprehensive manual assessment processes
          </li>
          <li>For accurate, detailed SDG mapping, please refer to official course documentation and detailed curriculum
            mapping initiatives</li>
          <li>We intend this mapping to be a genuine tool for strategic transformation and curriculum enhancement, not a reporting tool. We hope this tool helps bring meaningful transformation of our educational programs.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Top Bar for SDG Icons -->
  <div id="top-bar">
      <div class="sdg-icons-list" id="sdgIconsList">
        <div class="sdg-icon-item" data-sdg="1">
          <img src="logo/E Inverted Icons_WEB-01.png" alt="SDG 1 - No Poverty" />
        </div>
        <div class="sdg-icon-item" data-sdg="2">
          <img src="logo/E Inverted Icons_WEB-02.png" alt="SDG 2 - Zero Hunger" />
        </div>
        <div class="sdg-icon-item" data-sdg="3">
          <img src="logo/E Inverted Icons_WEB-03.png" alt="SDG 3 - Good Health" />
        </div>
        <!-- Quality Education icon hidden as requested
        <div class="sdg-icon-item" data-sdg="4">
          <img src="logo/E Inverted Icons_WEB-04.png" alt="SDG 4 - Quality Education" />
        </div>
        -->
        <div class="sdg-icon-item" data-sdg="5">
          <img src="logo/E Inverted Icons_WEB-05.png" alt="SDG 5 - Gender Equality" />
        </div>
        <div class="sdg-icon-item" data-sdg="6">
          <img src="logo/E Inverted Icons_WEB-06.png" alt="SDG 6 - Clean Water" />
        </div>
        <div class="sdg-icon-item" data-sdg="7">
          <img src="logo/E Inverted Icons_WEB-07.png" alt="SDG 7 - Clean Energy" />
        </div>
        <div class="sdg-icon-item" data-sdg="8">
          <img src="logo/E Inverted Icons_WEB-08.png" alt="SDG 8 - Decent Work" />
        </div>
        <div class="sdg-icon-item" data-sdg="9">
          <img src="logo/E Inverted Icons_WEB-09.png" alt="SDG 9 - Industry & Innovation" />
        </div>
        <div class="sdg-icon-item" data-sdg="10">
          <img src="logo/E Inverted Icons_WEB-10.png" alt="SDG 10 - Reduced Inequalities" />
        </div>
        <div class="sdg-icon-item" data-sdg="11">
          <img src="logo/E Inverted Icons_WEB-11.png" alt="SDG 11 - Sustainable Cities" />
        </div>
        <div class="sdg-icon-item" data-sdg="12">
          <img src="logo/E Inverted Icons_WEB-12.png" alt="SDG 12 - Responsible Production" />
        </div>
        <div class="sdg-icon-item" data-sdg="13">
          <img src="logo/E Inverted Icons_WEB-13.png" alt="SDG 13 - Climate Action" />
        </div>
        <div class="sdg-icon-item" data-sdg="14">
          <img src="logo/E Inverted Icons_WEB-14.png" alt="SDG 14 - Life Below Water" />
        </div>
        <div class="sdg-icon-item" data-sdg="15">
          <img src="logo/E Inverted Icons_WEB-15.png" alt="SDG 15 - Life on Land" />
        </div>
        <div class="sdg-icon-item" data-sdg="16">
          <img src="logo/E Inverted Icons_WEB-16.png" alt="SDG 16 - Peace and Justice" />
        </div>
        <div class="sdg-icon-item" data-sdg="17">
          <img src="logo/E Inverted Icons_WEB-17.png" alt="SDG 17 - Partnerships" />
        </div>
      </div>
      <!-- Separator -->
      <div class="top-bar-separator"></div>
      <!-- Search Container -->
      <div class="search-container top-bar-search">
        <input type="text" id="disciplineSearch" placeholder="Search specialisations..." class="search-input">
        <div id="disciplineDropdown" class="dropdown-content">
          <!-- Populated by JS -->
        </div>
      </div>
      <!-- Separator -->
      <div class="top-bar-separator"></div>
      <!-- Faculty Icons Moved Here -->
      <div class="faculty-icons-list" id="facultyIconsListTop"> <!-- Renamed ID to avoid conflict -->
        <div class="faculty-icon-item" data-faculty="ALL">
          <img src="faculty/all.svg" alt="All faculties" />
        </div>
        <div class="faculty-icon-item" data-faculty="ADA">
          <img src="faculty/ada.svg" alt="Arts, Design & Architecture" />
        </div>
        <div class="faculty-icon-item" data-faculty="BUSINESS">
          <img src="faculty/business.svg" alt="Business School" />
        </div>
        <div class="faculty-icon-item" data-faculty="ENG">
          <img src="faculty/engineering.svg" alt="Engineering" />
        </div>
        <div class="faculty-icon-item" data-faculty="LAW">
          <img src="faculty/law.svg" alt="Law & Justice" />
        </div>
        <div class="faculty-icon-item" data-faculty="MED">
          <img src="faculty/medicine.svg" alt="Medicine & Health" />
        </div>
        <div class="faculty-icon-item" data-faculty="SCIENCE">
          <img src="faculty/science.svg" alt="Science" />
        </div>
        <div class="faculty-icon-item" data-faculty="CANBERRA">
          <img src="faculty/canberra.svg" alt="UNSW Canberra" />
        </div>
      </div>
      <!-- Separator -->
      <div class="top-bar-separator"></div>
      <!-- Moved Analysis Data Source Section -->
      <div class="top-bar-section" id="data-source-section">
        <h3 class="top-bar-section-title">Analysis Data Source</h3>
        <div class="data-source-row">
          <div class="data-source-toggle">
            <div id="ternaryToggleContainer" class="ternary-toggle-container">
              <div id="ternaryToggle" class="ternary-toggle state-2"> <!-- Set initial state to v3 -->
                <!-- Labels moved inside -->
                <div class="toggle-labels">
                  <span>v1</span>
                  <span>v2</span>
                  <span>v3</span>
                </div>
                <div class="toggle-knob"></div>
              </div>
            </div>
          </div>
          <!-- Separator within data source section -->
          <div class="top-bar-separator"></div>
          <div class="course-count-container">
            <p id="course-count" style="font-size: 1.1em; color: #666; margin: 0;"></p>
          </div>
        </div>
      </div>
      <!-- End Moved Section -->
      <!-- Separator after course count -->
      <div class="top-bar-separator"></div>
      <!-- SDG Knowledge Graph Link (moved after course count) -->
      <div class="button-group knowledge-graph-container"> <!-- Added class for styling -->
        <a href="https://fiacrerougieux.github.io/sdg_network_explorer/" target="_blank" class="knowledge-graph-link">
          <img src="other/sdg_network.png" alt="SDG Knowledge Graph">
          <span>knowledge graph</span>
        </a>
      </div>
  </div>

  <!-- Compact Visualization Icons -->
  <div id="compact-viz-icons">
    <div class="visualisation-icons">
      <button id="heatmapBtn" class="viz-button active">
        <img src="visualisation/heatmap.svg" alt="Heatmap" />
      </button>
      <button id="cumulativeBtn" class="viz-button">
        <img src="visualisation/cumulative-heatmap.svg" alt="Cumulative Heatmap" />
      </button>
      <button id="radarBtn" class="viz-button">
        <img src="visualisation/radar-plot.svg" alt="Radar Chart" />
      </button>
      <button id="exportPNG" class="viz-button">
        <img src="visualisation/export-visualization.svg" alt="Export" />
      </button>
    </div>
  </div>



  <!-- Main Content Area -->
  <div id="main-content">
    <!-- Plot Area -->
    <div id="plot-container">
      <div id="plot-container-top">
        <div id="bubble-chart-div" class="chart-div" style="width: 100%; height: 100%; display: none;"></div>
      </div>
      <div id="plot-container-bottom">
        <div id="heatmap-div" class="chart-div" style="width: 100%; height: 100%; display: none;"></div>
        <div id="radar-div" class="chart-div" style="width: 100%; height: 100%; display: none;"></div>
        <!-- Cumulative heatmap will reuse #heatmap-div -->
      </div>
    </div>
  </div>

  <!-- Main Script -->
  <script>
    // Function to adjust main content padding based on top bar height
    function adjustMainContentPadding() {
      const topBar = document.getElementById('top-bar');
      const mainContent = document.getElementById('main-content');
      const topBarHeight = topBar.offsetHeight;
      
      // Set the top padding of main content to match the top bar height plus some extra space
      mainContent.style.paddingTop = (topBarHeight + 20) + 'px';
      
      // Set a CSS variable for the top bar height that can be used in media queries
      document.documentElement.style.setProperty('--top-bar-height', topBarHeight + 'px');
      
      // Adjust plot container height if needed
      const plotContainer = document.getElementById('plot-container');
      if (window.innerWidth <= 768) {
        plotContainer.style.height = `calc(100vh - 30px - ${topBarHeight}px)`;
      } else if (window.innerWidth <= 1024) {
        plotContainer.style.height = `calc(100vh - 35px - ${topBarHeight}px)`;
      } else {
        plotContainer.style.height = `calc(100vh - 40px - ${topBarHeight}px)`;
      }
    }

    // On-load Modal
    function showWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.style.display = 'flex';
      // Add a small delay before adding the active class to trigger the animation
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);
    }
    function hideWelcomeModal() {
      const modal = document.getElementById('welcomeModal');
      modal.classList.remove('active');
      // Wait for the animation to complete before hiding the modal
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    // Show the modal once DOM content has loaded
    document.addEventListener('DOMContentLoaded', function () {
      showWelcomeModal();
      
      // Close modal when clicking outside the modal content
      const modal = document.getElementById('welcomeModal');
      modal.addEventListener('click', function(event) {
        // Check if the click was on the modal overlay (not on the modal content)
        if (event.target === modal) {
          hideWelcomeModal();
        }
      });
      
      // Optionally auto-open the disclaimer
      // toggleDisclaimer();
    });

    // Toggle sidebar disclaimer
    function toggleSidebarDisclaimer() {
      const content = document.getElementById('sidebarDisclaimerContent');
      const button = document.querySelector('.disclaimer-button');
      if (content.style.display === '' || content.style.display === 'block') {
        content.style.display = 'none';
        button.innerHTML = 'â–¼ Disclaimer';
        button.classList.remove('active');
      } else {
        content.style.display = 'block';
        button.innerHTML = 'â–² Disclaimer';
        button.classList.add('active');
      }
    }

    // Function to parse a CSV line respecting quotes
    function parseCsvLine(line, delimiter = ',') {
        const values = [];
        let currentVal = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];

            if (char === '"') {
                // Handle quotes: toggle inQuotes state or handle escaped quotes ("")
                if (inQuotes && line[i + 1] === '"') {
                    currentVal += '"'; // Escaped quote
                    i++; // Skip next quote
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === delimiter && !inQuotes) {
                // End of a value
                // Trim quotes only if they are at the very start and end of the value
                const trimmedVal = currentVal.trim();
                if (trimmedVal.startsWith('"') && trimmedVal.endsWith('"')) {
                    values.push(trimmedVal.substring(1, trimmedVal.length - 1).replace(/""/g, '"'));
                } else {
                    values.push(trimmedVal);
                }
                currentVal = '';
            } else {
                // Regular character
                currentVal += char;
            }
        }
        // Add the last value, handling potential quotes
        const trimmedVal = currentVal.trim();
        if (trimmedVal.startsWith('"') && trimmedVal.endsWith('"')) {
            values.push(trimmedVal.substring(1, trimmedVal.length - 1).replace(/""/g, '"'));
        } else {
            values.push(trimmedVal);
        }
        return values;
    }


    // Toggle sidebar
    document.getElementById('toggle-sidebar').addEventListener('click', function () {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('main-content').classList.toggle('sidebar-active');
    });

    // ---------- Data & Visualization Logic -----------
    let currentDiscipline = 'ALL';
    let currentFaculty = 'ALL';
    let currentChartType = 'heatmap'; // Default active viz
    let previousChartType = null;
    const dataSources = [
      'sdg_analysis_llm_match.csv',      // v1
      'sdg_analysis_llm.csv',            // v2
      'sdg_analysis_llm_with_targets.csv' // v3
    ];
    const dataSourceLabels = [
      'Data: v1 (Match)',
      'Data: v2 (LLM)',
      'Data: v3 (LLM+Targets)'
    ];
    let currentDataSourceIndex = 2; // Start with v3 (index 2)
    let currentDataFile = dataSources[currentDataSourceIndex];
    let currentSDG = 1; // default SDG (updated when user clicks an SDG icon)

    let constants = {};

    async function loadConstants() {
      try {
        const response = await fetch('constants.json');
        constants = await response.json();
        window.sdgNames = constants.sdgNames; // Make sdgNames globally available as before
      } catch (error) {
        console.error('Error loading constants:', error);
      }
    }

    // Note: getPlotDimensions might need adjustment if called by D3 charts now,
    // as they target specific divs. Plotly handles its own resizing within its div.
    // D3 charts might need to get dimensions from their specific div if resize logic is added there.

    // Generic resize handler for Plotly charts if needed, targeting the visible one.
    // D3 resize needs to be handled within bubblechart.js if required.
    window.addEventListener('resize', function () {
      const activePlotlyDivId = currentChartType === 'heatmap' || currentChartType === 'cumulative' ? 'heatmap-div'
                              : currentChartType === 'radar' ? 'radar-div'
                              : null;
      if (activePlotlyDivId) {
        const container = document.getElementById(activePlotlyDivId);
        if (container && container.offsetParent !== null) { // Check if visible
          Plotly.Plots.resize(container);
        }
      }
      // If bubble chart needs resize handling, it should be added within bubblechart.js
      // listening to resize and redrawing based on #bubble-chart-div dimensions.
    });

    // Load CSV data
    async function loadData() {
      try {
        const response = await fetch(currentDataFile);
        const csvText = await response.text();
        const lines = csvText.split('\n');

        if (lines.length === 0) {
          console.error('CSV file is empty.');
          return [];
        }

        // Determine delimiter and column indices from header
        const headerLine = lines[0];
        let delimiter = ',';
        if (headerLine.split('\t').length > headerLine.split(',').length) {
          delimiter = '\t';
        }

        const headers = headerLine.split(delimiter).map(header => header.trim().replace(/^"(.+)"$/, '$1'));
        const getColumnIndex = (columnName) => headers.indexOf(columnName);

        const colIndices = {
          course_code: getColumnIndex('course_code'),
          sdg_number: getColumnIndex('sdg_number'),
          sdg_name: getColumnIndex('sdg_name'),
          addressed: getColumnIndex('addressed'),
          justification: getColumnIndex('justification'),
          timestamp: getColumnIndex('timestamp'),
          target_number: getColumnIndex('target_number'),
          target_name: getColumnIndex('target_name')
        };

        // Check if essential columns are present
        const essentialColumns = ['course_code', 'sdg_number', 'sdg_name', 'addressed', 'justification', 'timestamp'];
        const missingEssentialColumns = essentialColumns.filter(col => colIndices[col] === -1);

        if (missingEssentialColumns.length > 0) {
          console.error(`Missing essential columns in CSV: ${missingEssentialColumns.join(', ')}`);
          return [];
        }

        const data = lines.slice(1).map(line => {
          if (!line.trim()) return null; // Skip empty lines
          const values = parseCsvLine(line, delimiter); // Use the robust parser

          // Check if the number of values matches the number of headers
          if (values.length !== headers.length) {
              console.warn(`Skipping line due to mismatched columns: ${line}`);
              console.warn(`Expected ${headers.length} columns, found ${values.length}`);
              console.warn(`Values found:`, values);
              return null; // Skip this line
          }

          // No need for cleanValue anymore as parseCsvLine handles quotes
          const rowData = {
            course_code: values[colIndices.course_code] || '',
            sdg_number: parseInt(values[colIndices.sdg_number]) || 0,
            sdg_name: values[colIndices.sdg_name] || '',
            addressed: (values[colIndices.addressed] || '').toLowerCase() === 'yes' ||
                       (values[colIndices.addressed] || '').toLowerCase() === 'supported' ||
                       (values[colIndices.addressed] || '').toLowerCase() === 'focus',
            justification: values[colIndices.justification] || '',
            timestamp: values[colIndices.timestamp] || ''
          };

          // Include target information if columns exist
          if (colIndices.target_number !== -1 && values[colIndices.target_number] !== undefined) {
            rowData.target_number = values[colIndices.target_number];
          }
          if (colIndices.target_name !== -1 && values[colIndices.target_name] !== undefined) {
            rowData.target_name = values[colIndices.target_name];
          }

          return rowData;
        }).filter(row => row && row.course_code); // Filter out nulls and rows without course_code

        // Rebuild discipline dropdown
        const disc = getDisciplines(data, currentFaculty);
        const dropdown = document.getElementById('disciplineDropdown');
        // If current discipline is not in the new list, reset it
        if (!currentDiscipline || !disc.includes(currentDiscipline)) {
          currentDiscipline = disc[0] || 'ALL';
        }
        
        // Clear previous dropdown items
        dropdown.innerHTML = '';
        
        // Add "ALL" option first
        const allItem = document.createElement('div');
        allItem.className = 'dropdown-item' + (currentDiscipline === 'ALL' ? ' active' : '');
        allItem.setAttribute('data-value', 'ALL');
        allItem.textContent = 'All Specialisations';
        dropdown.appendChild(allItem);
        
        // Add discipline options
        disc.forEach(d => {
          const item = document.createElement('div');
          item.className = 'dropdown-item' + (d === currentDiscipline ? ' active' : '');
          item.setAttribute('data-value', d);
          item.textContent = constants.specializationNames[d] || d;
          dropdown.appendChild(item);
        });
        
        // Setup search and dropdown functionality
        setupDisciplineSearch();

        return data;
      } catch (error) {
        console.error('Error loading data:', error);
        return [];
      }
    }

    function updateCourseCount(data) {
      // Count all unique courses
      const uniqueCourses = new Set(data.map(row => row.course_code));
      document.getElementById('course-count').innerHTML =
        `Total Courses: <strong>${uniqueCourses.size}</strong>`;
    }

    function getDisciplines(data, selectedFaculty = 'ALL') {
      const disciplines = new Set(
        data.filter(row => {
          const d = row.course_code.substring(0, 4);
          return (selectedFaculty === 'ALL' || constants.facultyMapping[d] === selectedFaculty);
        }).map(row => row.course_code.substring(0, 4))
      );
      return Array.from(disciplines).sort();
    }

    function getCourseYear(courseCode) {
      const yearNum = parseInt(courseCode.charAt(4));
      return yearNum >= 5 ? 4 : yearNum;
    }

    // Heatmap & Radar code
    // Filter data by discipline & faculty
    function filterDataByDiscipline(data, discipline) {
      return data.filter(row => {
        const rowDiscipline = row.course_code.substring(0, 4);
        const rowFaculty = constants.facultyMapping[rowDiscipline];
        if (currentFaculty !== 'ALL' && rowFaculty !== currentFaculty) {
          return false;
        }
        return (discipline === 'ALL') ? true : (rowDiscipline === discipline);
      });
    }

    // Bubble Chart
    // PNG Export
// Function to download a specific visualization as PNG
function downloadPNG(vizType = currentChartType, filename = null) {
  // Find the appropriate SVG based on the visualization type
  let svg;
  if (vizType === 'bubble') {
    svg = document.querySelector('#bubble-chart-div svg');
  } else if (vizType === 'heatmap' || vizType === 'cumulative') {
    svg = document.querySelector('#heatmap-div svg');
  } else if (vizType === 'radar') {
    svg = document.querySelector('#radar-div svg');
  }
  
  if (!svg) {
    console.error(`No SVG found for visualization type: ${vizType}`);
    return;
  }
  
  const svgData = new XMLSerializer().serializeToString(svg);

  const canvas = document.createElement('canvas');
  const box = svg.getBoundingClientRect();
  canvas.width = box.width;
  canvas.height = box.height;

  const img = new Image();
  const blob = new Blob([svgData], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);

  img.onload = () => {
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
    
    // Generate appropriate filename if not provided
    if (!filename) {
      const disciplineText = currentDiscipline === 'ALL' ? 'all_disciplines' : currentDiscipline;
      const facultyText = currentFaculty === 'ALL' ? 'all_faculties' : currentFaculty;
      
      if (vizType === 'bubble') {
        filename = `sdg${currentSDG}_bubble_chart_${facultyText}.png`;
      } else if (vizType === 'heatmap') {
        filename = `sdg_heatmap_${disciplineText}_${facultyText}.png`;
      } else if (vizType === 'cumulative') {
        filename = `sdg_cumulative_${disciplineText}_${facultyText}.png`;
      } else if (vizType === 'radar') {
        filename = `sdg_radar_${disciplineText}_${facultyText}.png`;
      }
    }
    
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };
  img.src = url;
}

// Function to download all plots sequentially
function downloadAllPlots() {
  // Store current state to restore later
  const originalChartType = currentChartType;
  
  // Create a status indicator
  const statusIndicator = document.createElement('div');
  statusIndicator.style.position = 'fixed';
  statusIndicator.style.top = '50%';
  statusIndicator.style.left = '50%';
  statusIndicator.style.transform = 'translate(-50%, -50%)';
  statusIndicator.style.padding = '15px 20px';
  statusIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  statusIndicator.style.color = 'white';
  statusIndicator.style.borderRadius = '5px';
  statusIndicator.style.zIndex = '9999';
  statusIndicator.style.fontWeight = 'bold';
  statusIndicator.textContent = 'Preparing downloads...';
  document.body.appendChild(statusIndicator);
  
  // Define the visualization types to download
  const vizTypes = ['bubble', 'heatmap', 'cumulative', 'radar'];
  let currentIndex = 0;
  
  // Function to process the next visualization
  function processNextViz() {
    if (currentIndex >= vizTypes.length) {
      // All done, restore original state and remove status indicator
      if (originalChartType === 'bubble') {
        // For bubble chart, just make sure it's visible
        document.getElementById('bubble-chart-div').style.display = 'block';
      } else {
        // For other chart types, click the appropriate button
        const vizBtnId = originalChartType === 'radar' ? '#radarBtn' : 
                         (originalChartType === 'cumulative' ? '#cumulativeBtn' : '#heatmapBtn');
        document.querySelector(`#compact-viz-icons .visualisation-icons ${vizBtnId}`).click();
      }
      
      // Remove status indicator after a short delay
      setTimeout(() => {
        document.body.removeChild(statusIndicator);
      }, 500);
      
      return;
    }
    
    const vizType = vizTypes[currentIndex];
    statusIndicator.textContent = `Downloading ${vizType} chart (${currentIndex + 1}/${vizTypes.length})...`;
    
    // Switch to the current visualization type
    if (vizType === 'bubble') {
      // For bubble chart, just make sure it's visible
      document.getElementById('bubble-chart-div').style.display = 'block';
    } else {
      // For other chart types, click the appropriate button
      const vizBtnId = vizType === 'radar' ? '#radarBtn' : 
                       (vizType === 'cumulative' ? '#cumulativeBtn' : '#heatmapBtn');
      document.querySelector(`#compact-viz-icons .visualisation-icons ${vizBtnId}`).click();
    }
    
    // Wait for the visualization to render
    setTimeout(() => {
      // Download the current visualization
      downloadPNG(vizType);
      
      // Move to the next visualization after a short delay
      currentIndex++;
      setTimeout(processNextViz, 500);
    }, 500);
  }
  
  // Start the process
  processNextViz();
}

// Update event listener for the export button
document.getElementById('exportPNG').addEventListener('click', downloadAllPlots);

    // Event Listener for Custom Ternary Toggle
    const ternaryToggle = document.getElementById('ternaryToggle');
    ternaryToggle.addEventListener('click', function () {
      currentDataSourceIndex = (currentDataSourceIndex + 1) % dataSources.length; // Cycle through 0, 1, 2
      currentDataFile = dataSources[currentDataSourceIndex];

      // Update toggle visual state
      this.classList.remove('state-0', 'state-1', 'state-2');
      this.classList.add(`state-${currentDataSourceIndex}`);

      console.log(`Switched data source to: ${currentDataFile} (State: ${currentDataSourceIndex})`); // Debugging log

      loadData().then(data => {
        updateCourseCount(data);
        // Update both bubble chart and the currently active bottom chart
        createBubbleChart(data, currentSDG, true); // Re-enable animation on data source change
        if (currentChartType === 'radar') {
          createRadar(data);
        } else if (currentChartType === 'heatmap') {
          createHeatmap(data, false);
        } else if (currentChartType === 'cumulative') {
          createHeatmap(data, true);
        }
      });
    });

    // The redrawVisualization function is no longer needed as we update both charts explicitly
    // function redrawVisualization(data) {
    //   const shouldAnimate = previousChartType === 'bubble' && currentChartType === 'bubble';
    //   // Which button is active?
    //   if (currentChartType === 'bubble') {
    //     createBubbleChart(data, currentSDG, shouldAnimate);
    //   } else if (currentChartType === 'radar') {
    //     createRadar(data);
    //   } else if (currentChartType === 'heatmap') {
    //     createHeatmap(data, false);
    //   } else if (currentChartType === 'cumulative') {
    //     createHeatmap(data, true);
    //   }
    // }

    // Add event listeners to the visualization buttons in the compact icons
    document.querySelector('#compact-viz-icons .visualisation-icons #radarBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'radar');
      loadData().then(data => createRadar(data));
    });
    document.querySelector('#compact-viz-icons .visualisation-icons #heatmapBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'heatmap');
      loadData().then(data => createHeatmap(data, false));
    });
    document.querySelector('#compact-viz-icons .visualisation-icons #cumulativeBtn').addEventListener('click', function () {
      setActiveVizButton(this, 'cumulative');
      loadData().then(data => createHeatmap(data, true));
    });
    document.querySelector('#compact-viz-icons .visualisation-icons #exportPNG').addEventListener('click', downloadPNG);

    function setActiveVizButton(btn, newChartType) {
      // Update chart type state
      previousChartType = currentChartType;
      currentChartType = newChartType;

      // Remove any existing tooltips when switching visualizations
      d3.select('body').select('.tooltip').remove();

      // Update active class visually
      document.querySelectorAll('#compact-viz-icons .visualisation-icons .viz-button').forEach(button => {
        button.classList.remove('active');
      });
      btn.classList.add('active');

      // Toggle visibility of chart divs within their respective containers
      if (newChartType === 'bubble') {
        // Show bubble chart in top container, hide others in top (if any)
        document.querySelectorAll('#plot-container-top .chart-div').forEach(div => {
          div.style.display = (div.id === 'bubble-chart-div') ? 'block' : 'none';
        });
        // Don't hide the bottom container's active chart
      } else {
        // Show selected chart in bottom container, hide others in bottom
        let targetDivId;
        if (newChartType === 'heatmap' || newChartType === 'cumulative') {
          targetDivId = 'heatmap-div';
        } else if (newChartType === 'radar') {
          targetDivId = 'radar-div';
        }
        document.querySelectorAll('#plot-container-bottom .chart-div').forEach(div => {
          div.style.display = (div.id === targetDivId) ? 'block' : 'none';
        });
        // Don't hide the top container's bubble chart
      }
    }


    // Faculty icon clicks (Top Bar)
    const facultyIconsListTop = document.getElementById('facultyIconsListTop'); // Updated ID
    facultyIconsListTop.querySelectorAll('.faculty-icon-item').forEach(item => {
      item.addEventListener('click', function () {
        facultyIconsListTop.querySelectorAll('.faculty-icon-item').forEach(el => el.classList.remove('active')); // Updated ID
        this.classList.add('active');
        currentFaculty = this.getAttribute('data-faculty');
        currentDiscipline = 'ALL'; // Reset discipline when faculty changes

        // Always ensure a bottom chart is active when faculty/discipline changes
        let bottomChartType = currentChartType;
        if (bottomChartType === 'bubble') { // If only bubble was active, default to heatmap
            bottomChartType = 'heatmap';
        }

        // Activate the appropriate bottom viz button
        let vizBtnId = bottomChartType === 'radar' ? '#radarBtn' : (bottomChartType === 'cumulative' ? '#cumulativeBtn' : '#heatmapBtn');
        const vizBtn = document.querySelector(`#compact-viz-icons .visualisation-icons ${vizBtnId}`);
        setActiveVizButton(vizBtn, bottomChartType); // Update button state and show correct bottom div

        // Reload data and redraw the selected bottom visualization
        loadData().then(data => {
            if (bottomChartType === 'radar') {
                createRadar(data);
            } else { // heatmap or cumulative
                createHeatmap(data, bottomChartType === 'cumulative');
            }
            // Bubble chart remains visible in the top container, no need to redraw unless SDG changes
        });
      });
    });

    // Setup discipline search and dropdown functionality
    function setupDisciplineSearch() {
      const searchInput = document.getElementById('disciplineSearch');
      const dropdown = document.getElementById('disciplineDropdown');
      const dropdownItems = dropdown.querySelectorAll('.dropdown-item');
      
      // Show dropdown when input is focused
      searchInput.addEventListener('focus', function() {
        dropdown.classList.add('show');
      });
      
      // Filter dropdown items as user types
      searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        let hasVisibleItems = false;
        
        dropdownItems.forEach(item => {
          const itemText = item.textContent.toLowerCase();
          const shouldShow = itemText.includes(searchText);
          item.style.display = shouldShow ? 'block' : 'none';
          if (shouldShow) hasVisibleItems = true;
        });
        
        // If no items match, show a message
        if (!hasVisibleItems && searchText) {
          if (!dropdown.querySelector('.no-results')) {
            const noResults = document.createElement('div');
            noResults.className = 'dropdown-item no-results';
            noResults.textContent = 'No matching specialisations found';
            noResults.style.fontStyle = 'italic';
            noResults.style.color = '#999';
            dropdown.appendChild(noResults);
          }
        } else {
          // Remove any existing "no results" message
          const noResults = dropdown.querySelector('.no-results');
          if (noResults) dropdown.removeChild(noResults);
        }
      });
      
      // Handle dropdown item clicks
      dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
          const selectedValue = this.getAttribute('data-value');
          const selectedText = this.textContent;
          
          // Update search input with selected text
          searchInput.value = selectedText;
          
          // Update active state in dropdown
          dropdownItems.forEach(el => el.classList.remove('active'));
          this.classList.add('active');
          
          // Hide dropdown
          dropdown.classList.remove('show');
          
          // Update current discipline and redraw visualization
          if (currentDiscipline !== selectedValue) {
            currentDiscipline = selectedValue;
            
            // Always ensure a bottom chart is active when discipline changes
            let bottomChartType = currentChartType;
            if (bottomChartType === 'bubble') { // If only bubble was active, default to heatmap
                bottomChartType = 'heatmap';
            }
            
            // Activate the appropriate bottom viz button
            let vizBtnId = bottomChartType === 'radar' ? '#radarBtn' : (bottomChartType === 'cumulative' ? '#cumulativeBtn' : '#heatmapBtn');
            const vizBtn = document.querySelector(`#compact-viz-icons .visualisation-icons ${vizBtnId}`);
            setActiveVizButton(vizBtn, bottomChartType); // Update button state and show correct bottom div
            
            // Reload data and redraw the selected bottom visualization
            loadData().then(data => {
                if (bottomChartType === 'radar') {
                    createRadar(data);
                } else { // heatmap or cumulative
                    createHeatmap(data, bottomChartType === 'cumulative');
                }
                // Bubble chart remains visible in the top container
            });
          }
        });
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !dropdown.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });
      
      // Set initial search input value based on current discipline
      const activeDiscipline = dropdown.querySelector('.dropdown-item.active');
      if (activeDiscipline) {
        searchInput.value = activeDiscipline.textContent;
      }
    }

    // SDG icon clicks
    const sdgIconsList = document.getElementById('sdgIconsList');
    sdgIconsList.querySelectorAll('.sdg-icon-item').forEach(item => {
      item.addEventListener('click', function () {
        sdgIconsList.querySelectorAll('.sdg-icon-item').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
        currentSDG = parseInt(this.getAttribute('data-sdg')) || 1;

        // Note: We don't need to activate any button for bubble chart since it's not in the compact icons

        // Determine if animation is needed (always animate when SDG is clicked)
        const shouldAnimate = true; // Always animate when SDG is clicked

        // Update state *after* checking animation, but before drawing
        previousChartType = currentChartType; // Store what was active before
        currentChartType = 'bubble'; // Bubble is now the focus, even if bottom chart remains

        // Ensure bubble chart div is visible
        document.getElementById('bubble-chart-div').style.display = 'block';

        // Redraw bubble chart
        loadData().then(data => createBubbleChart(data, currentSDG, shouldAnimate));

        // Keep the bottom chart visible if it was something other than bubble
        // No need to explicitly redraw bottom chart unless faculty/discipline changes
      });
    });

    // Modal SDG icon clicks
    const modalSdgIconsList = document.getElementById('modalSdgIconsList');
    if (modalSdgIconsList) { // Check if the element exists
      modalSdgIconsList.querySelectorAll('.sdg-icon-item').forEach(item => {
        item.addEventListener('click', function () {
          const clickedSDG = parseInt(this.getAttribute('data-sdg')) || 1;
          currentSDG = clickedSDG;

          // Deactivate all top bar icons and activate the corresponding one
          const topBarIcons = document.getElementById('sdgIconsList');
          if (topBarIcons) {
            topBarIcons.querySelectorAll('.sdg-icon-item').forEach(el => el.classList.remove('active'));
            const correspondingTopBarIcon = topBarIcons.querySelector(`.sdg-icon-item[data-sdg="${clickedSDG}"]`);
            if (correspondingTopBarIcon) {
              correspondingTopBarIcon.classList.add('active');
            }
          }

          // Activate bubble chart button and display
          const bubbleBtn = document.querySelector('#sidebar .visualisation-icons #bubbleBtn');
          // setActiveVizButton(bubbleBtn, 'bubble'); // Ensure top div is shown

          const shouldAnimate = currentChartType === 'bubble'; // Animate if bubble was the main chart type

          // Update state
          previousChartType = currentChartType;
          currentChartType = 'bubble'; // Bubble is now the focus

          // Ensure bubble chart div is visible
          document.getElementById('bubble-chart-div').style.display = 'block';

          // Redraw bubble chart
          loadData().then(data => createBubbleChart(data, currentSDG, shouldAnimate));

          // Hide the modal
          hideWelcomeModal();
        });
      });
    }

    // Modal Faculty icon clicks
    const modalFacultyIconsList = document.getElementById('modalFacultyIconsList');
    if (modalFacultyIconsList) { // Check if the element exists
      modalFacultyIconsList.querySelectorAll('.faculty-icon-item').forEach(item => {
        item.addEventListener('click', function () {
          const clickedFaculty = this.getAttribute('data-faculty');
          currentFaculty = clickedFaculty;

          // Deactivate all TOP BAR faculty icons and activate the corresponding one
          const topBarFacultyIcons = document.getElementById('facultyIconsListTop'); // Updated ID
          if (topBarFacultyIcons) {
            topBarFacultyIcons.querySelectorAll('.faculty-icon-item').forEach(el => el.classList.remove('active'));
            const correspondingTopBarIcon = topBarFacultyIcons.querySelector(`.faculty-icon-item[data-faculty="${clickedFaculty}"]`); // Updated ID
            if (correspondingTopBarIcon) {
              correspondingTopBarIcon.classList.add('active');
            }
          }

          // Always ensure a bottom chart is active when faculty/discipline changes from modal
          let bottomChartType = currentChartType;
          if (bottomChartType === 'bubble') { // If only bubble was active, default to heatmap
              bottomChartType = 'heatmap';
          }

          // Activate the appropriate bottom viz button
          let vizBtnId = bottomChartType === 'radar' ? '#radarBtn' : (bottomChartType === 'cumulative' ? '#cumulativeBtn' : '#heatmapBtn');
          const vizBtn = document.querySelector(`#compact-viz-icons .visualisation-icons ${vizBtnId}`);
          setActiveVizButton(vizBtn, bottomChartType); // Update button state and show correct bottom div

          // Reload data and redraw the selected bottom visualization
          loadData().then(data => {
              if (bottomChartType === 'radar') {
                  createRadar(data);
              } else { // heatmap or cumulative
                  createHeatmap(data, bottomChartType === 'cumulative');
              }
              // Bubble chart remains visible in the top container
          });

          // Hide the modal
          hideWelcomeModal();
        });
      });
    }

    // Initial load
    loadConstants().then(() => {
      loadData().then(data => {
        updateCourseCount(data);

        // --- Initial Load Modifications ---
        // 1. Show Bubble Chart in top container for default SDG
        document.getElementById('bubble-chart-div').style.display = 'block'; // Make it visible
        createBubbleChart(data, currentSDG, false); // Draw initial bubble chart (no animation)

        // 2. Show Heatmap in bottom container for default ALL/ALL
        const heatmapBtn = document.querySelector('#compact-viz-icons .visualisation-icons #heatmapBtn');
        setActiveVizButton(heatmapBtn, 'heatmap'); // Set heatmap as active viz *button* and show bottom div
        createHeatmap(data, false); // Draw initial heatmap

        // Set the default chart type state after initial setup
        currentChartType = 'heatmap'; // Heatmap is the default selected viz type
        previousChartType = null;
        // --- End Initial Load Modifications ---
        
        // Adjust main content padding based on top bar height
        adjustMainContentPadding();
      });
    });
    
    // Add event listener for window resize to adjust padding
    window.addEventListener('resize', adjustMainContentPadding);
  </script>
</body>

</html>
